<!DOCTYPE html>
<html lang="de" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FAF Lackiererei - Admin Panel</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root,
      [data-theme="dark"] {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --bg-card: #1e293b;
        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border-color: #475569;
        --accent-primary: #60a5fa;
        --accent-success: #34d399;
        --accent-warning: #fbbf24;
        --accent-danger: #f87171;
        --shadow-light: rgba(0, 0, 0, 0.3);
        --shadow-medium: rgba(0, 0, 0, 0.4);
        --shadow-heavy: rgba(0, 0, 0, 0.6);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }

      .header {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 0;
        box-shadow: 0 2px 10px var(--shadow-light);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .admin-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .admin-details {
        text-align: right;
      }

      .admin-name {
        font-weight: 600;
        color: var(--text-primary);
      }

      .admin-role {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .theme-toggle {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
      }

      .theme-toggle:hover {
        background: var(--bg-tertiary);
        color: var(--accent-primary);
      }

      .logout-btn {
        background: var(--accent-danger);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .logout-btn:hover {
        background: #dc2626;
        transform: translateY(-1px);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
      }

      .page-subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 2rem;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
      }

      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .card {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px var(--shadow-light);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px var(--shadow-medium);
      }

      .stat-card {
        text-align: center;
        background: linear-gradient(135deg, var(--accent-primary), #8b5cf6);
        color: white;
        border: none;
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        opacity: 0.9;
        font-size: 0.95rem;
        font-weight: 500;
      }

      .section-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .users-section {
        grid-column: 1 / -1;
      }

      .users-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .search-box {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .search-input {
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.95rem;
        background: var(--bg-secondary);
        color: var(--text-primary);
        width: 300px;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        font-size: 0.95rem;
      }

      .btn-primary {
        background: var(--accent-primary);
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
      }

      .btn-success {
        background: var(--accent-success);
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-warning {
        background: var(--accent-warning);
        color: white;
      }

      .btn-warning:hover {
        background: #d97706;
      }

      .btn-danger {
        background: var(--accent-danger);
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
      }

      .users-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--bg-card);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px var(--shadow-light);
        border: 1px solid var(--border-color);
      }

      .users-table th {
        background: var(--bg-secondary);
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95rem;
      }

      .users-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
      }

      .users-table tbody tr:hover {
        background: var(--bg-secondary);
      }

      .users-table tbody tr:last-child td {
        border-bottom: none;
      }

      .status-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-block;
      }

      .status-active {
        background: rgba(16, 185, 129, 0.1);
        color: var(--accent-success);
        border: 1px solid rgba(16, 185, 129, 0.2);
      }

      .status-inactive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--accent-danger);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }

      .status-expired {
        background: rgba(245, 158, 11, 0.1);
        color: var(--accent-warning);
        border: 1px solid rgba(245, 158, 11, 0.2);
      }

      .status-valid {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-primary);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .actions-cell {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        box-shadow: 0 20px 60px var(--shadow-heavy);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      .modal-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 0.5rem;
        border-radius: 4px;
        transition: all 0.3s ease;
      }

      .close-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.95rem;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.95rem;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Alert Styles */
      .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .alert-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--accent-success);
        border: 1px solid rgba(16, 185, 129, 0.2);
      }

      .alert-error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--accent-danger);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }

      .alert-warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--accent-warning);
        border: 1px solid rgba(245, 158, 11, 0.2);
      }

      .alert-info {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-primary);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      /* System Info Styles */
      .system-info {
        font-size: 0.9rem;
        line-height: 1.6;
      }

      .system-info p {
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .system-info strong {
        color: var(--text-primary);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }

        .header-content {
          padding: 0 1rem;
          flex-wrap: wrap;
          gap: 1rem;
        }

        .users-header {
          flex-direction: column;
          align-items: stretch;
        }

        .search-box {
          justify-content: space-between;
        }

        .search-input {
          width: 100%;
          min-width: 200px;
        }

        .users-table {
          font-size: 0.85rem;
        }

        .users-table th,
        .users-table td {
          padding: 0.75rem;
        }

        .actions-cell {
          flex-direction: column;
          gap: 0.25rem;
        }

        .btn-sm {
          padding: 0.4rem 0.8rem;
          font-size: 0.8rem;
        }

        .modal-content {
          padding: 1.5rem;
          margin: 1rem;
        }

        .page-title {
          font-size: 2rem;
        }
      }

      /* Loading States */
      .loading {
        opacity: 0.7;
        pointer-events: none;
      }

      .spinner {
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--accent-primary);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 0.5rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Transitions */
      .card,
      .modal-content,
      .users-table,
      .btn,
      .form-input,
      .form-select,
      .search-input,
      .theme-toggle,
      .logout-btn {
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <i class="fas fa-tools"></i>
          FAF Lackiererei - Admin
        </div>
        <div class="admin-info">
          <div class="admin-details">
            <div class="admin-name" id="admin-name">Administrator</div>
            <div class="admin-role">System Administrator</div>
          </div>
          <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Abmelden
          </button>
        </div>
      </div>
    </header>
    <div class="container">
      <h1 class="page-title">Admin Dashboard</h1>
      <p class="page-subtitle">
        Benutzer- und System-Verwaltung für FAF Lackiererei
      </p>
      <div class="dashboard-grid">
        <div class="stats-cards">
          <div class="card stat-card">
            <div class="stat-number" id="total-users">0</div>
            <div class="stat-label">Gesamt Benutzer</div>
          </div>
          <div class="card stat-card">
            <div class="stat-number" id="active-users">0</div>
            <div class="stat-label">Aktive Benutzer</div>
          </div>
          <div class="card stat-card">
            <div class="stat-number" id="valid-licenses">0</div>
            <div class="stat-label">Gültige Lizenzen</div>
          </div>
          <div class="card stat-card">
            <div class="stat-number" id="expired-licenses">0</div>
            <div class="stat-label">Abgelaufene Lizenzen</div>
          </div>
        </div>
        <div class="card">
          <div class="section-title">
            <i class="fas fa-server"></i> System-Information
          </div>
          <div class="system-info">
            <p>
              <strong>Server-Status:</strong>
              <span style="color: var(--accent-success)">Online</span>
            </p>
            <p>
              <strong>Datenbank:</strong>
              <span style="color: var(--accent-success)">Verbunden</span>
            </p>
            <p>
              <strong>Letzte Aktualisierung:</strong>
              <span id="last-update">-</span>
            </p>
            <p>
              <strong>Auth-System:</strong>
              <span style="color: var(--accent-success)">Aktiv</span>
            </p>
            <p>
              <strong>Multi-Tenant:</strong>
              <span style="color: var(--accent-success)">Aktiviert</span>
            </p>
          </div>
        </div>
      </div>
      <div class="card users-section">
        <div class="users-header">
          <div class="section-title">
            <i class="fas fa-users"></i> Benutzer-Verwaltung
          </div>
          <div class="search-box">
            <input
              type="text"
              class="search-input"
              placeholder="Benutzer suchen..."
              id="search-input"
            />
            <button class="btn btn-primary" onclick="openCreateUserModal()">
              <i class="fas fa-plus"></i> Neuer Benutzer
            </button>
          </div>
        </div>
        <div id="alert-container"></div>
        <table class="users-table" id="users-table">
          <thead>
            <tr>
              <th>Benutzer</th>
              <th>E-Mail</th>
              <th>Rolle</th>
              <th>Status</th>
              <th>Lizenz</th>
              <th>Läuft ab</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 2rem">
                <div class="spinner"></div>
                Lade Benutzer...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- User Modal -->
    <div class="modal" id="user-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modal-title">Neuer Benutzer</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>

        <form id="user-form">
          <div class="form-group">
            <label class="form-label">Benutzername *</label>
            <input type="text" class="form-input" id="username" required />
          </div>

          <div class="form-group">
            <label class="form-label">E-Mail *</label>
            <input type="email" class="form-input" id="email" required />
          </div>

          <div class="form-group" id="password-group">
            <label class="form-label">Passwort *</label>
            <input type="password" class="form-input" id="password" required />
          </div>

          <div class="form-group">
            <label class="form-label">Rolle</label>
            <select class="form-select" id="role">
              <option value="user">Benutzer</option>
              <option value="admin">Administrator</option>
            </select>
          </div>

          <div class="form-group">
            <button type="submit" class="btn btn-primary" id="save-btn">
              <i class="fas fa-save"></i> Speichern
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal()"
              style="
                margin-left: 1rem;
                background: var(--bg-secondary);
                color: var(--text-primary);
                border: 1px solid var(--border-color);
              "
            >
              Abbrechen
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- License Modal -->
    <div class="modal" id="license-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Lizenz-Verwaltung</h3>
          <button class="close-btn" onclick="closeLicenseModal()">
            &times;
          </button>
        </div>

        <div id="license-details">
          <p><strong>Benutzer:</strong> <span id="license-username">-</span></p>
          <p>
            <strong>Aktueller Status:</strong>
            <span id="license-current-status">-</span>
          </p>
          <p><strong>Läuft ab:</strong> <span id="license-expires">-</span></p>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 1rem">
          <button
            type="button"
            class="btn btn-success"
            onclick="extendLicense()"
          >
            <i class="fas fa-calendar-plus"></i> Um 1 Jahr verlängern
          </button>
          <button
            type="button"
            class="btn btn-warning"
            onclick="deactivateLicense()"
          >
            <i class="fas fa-ban"></i> Deaktivieren
          </button>
        </div>
      </div>
    </div>

    <script>
      let users = [];
      let currentUser = null;
      let editingUserId = null;

      // Theme Management
      function initTheme() {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        updateThemeIcon(savedTheme);
      }

      function toggleTheme() {
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";

        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeIcon(newTheme);
      }

      function updateThemeIcon(theme) {
        const icon = document.getElementById("theme-icon");
        icon.className = theme === "light" ? "fas fa-moon" : "fas fa-sun";
      }

      // App Initialization
      document.addEventListener("DOMContentLoaded", async () => {
        initTheme();
        await checkAdminAuth();
        await loadDashboardData();
        setupEventListeners();
      });

      // Admin Auth Check
      async function checkAdminAuth() {
        try {
          const user = JSON.parse(localStorage.getItem("user") || "{}");

          if (!user.id || user.role !== "admin") {
            window.location.href = "/login.html";
            return;
          }

          // Session check
          const response = await fetch("/api/auth/session-check", {
            credentials: "include",
          });

          if (!response.ok) {
            localStorage.removeItem("user");
            window.location.href = "/login.html";
            return;
          }

          document.getElementById("admin-name").textContent = user.username;
        } catch (error) {
          console.error("Auth-Check Fehler:", error);
          window.location.href = "/login.html";
        }
      }

      // Dashboard Data Loading
      async function loadDashboardData() {
        try {
          await Promise.all([loadUserStats(), loadUsers(), loadSystemInfo()]);
        } catch (error) {
          console.error("Fehler beim Laden der Dashboard-Daten:", error);
          showAlert("Fehler beim Laden der Daten", "error");
        }
      }

      // Load User Statistics
      async function loadUserStats() {
        try {
          const response = await fetch("/api/admin/users/stats", {
            credentials: "include",
          });
          if (!response.ok)
            throw new Error("Fehler beim Laden der Statistiken");

          const stats = await response.json();

          document.getElementById("total-users").textContent =
            stats.total_users || 0;
          document.getElementById("active-users").textContent =
            stats.active_users || 0;
          document.getElementById("valid-licenses").textContent =
            stats.valid_licenses || 0;
          document.getElementById("expired-licenses").textContent =
            stats.expired_licenses || 0;
        } catch (error) {
          console.error("Stats-Fehler:", error);
        }
      }

      // Load All Users
      async function loadUsers() {
        try {
          const response = await fetch("/api/admin/users", {
            credentials: "include",
          });
          if (!response.ok) throw new Error("Fehler beim Laden der Benutzer");

          users = await response.json();
          renderUsers(users);
        } catch (error) {
          console.error("Users-Fehler:", error);
          showAlert("Fehler beim Laden der Benutzer", "error");
        }
      }

      // Load System Info
      async function loadSystemInfo() {
        document.getElementById("last-update").textContent =
          new Date().toLocaleString("de-DE");
      }

      // Render Users Table
      function renderUsers(userList) {
        const tbody = document.getElementById("users-tbody");

        if (userList.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                Keine Benutzer gefunden
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = userList
          .map((user) => {
            const licenseStatus = user.license_expires
              ? new Date(user.license_expires) > new Date()
                ? "valid"
                : "expired"
              : "none";

            return `
              <tr>
                <td>
                  <div>
                    <strong>${user.username}</strong>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                      ID: ${user.id}
                    </div>
                  </div>
                </td>
                <td>${user.email}</td>
                <td>
                  <span class="status-badge ${
                    user.role === "admin" ? "status-valid" : "status-active"
                  }">
                    ${user.role === "admin" ? "Administrator" : "Benutzer"}
                  </span>
                </td>
                <td>
                  <span class="status-badge ${
                    user.is_active ? "status-active" : "status-inactive"
                  }">
                    ${user.is_active ? "Aktiv" : "Inaktiv"}
                  </span>
                </td>
                <td>
                  <span class="status-badge status-${licenseStatus}">
                    ${
                      licenseStatus === "valid"
                        ? "Gültig"
                        : licenseStatus === "expired"
                        ? "Abgelaufen"
                        : "Keine"
                    }
                  </span>
                </td>
                <td>
                  ${
                    user.license_expires
                      ? new Date(user.license_expires).toLocaleDateString(
                          "de-DE"
                        )
                      : "-"
                  }
                </td>
                <td>
                  <div class="actions-cell">
                    <button class="btn btn-sm btn-primary" onclick="editUser(${
                      user.id
                    })">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="manageLicense(${
                      user.id
                    })">
                      <i class="fas fa-key"></i>
                    </button>
                    ${
                      user.role !== "admin"
                        ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                        <i class="fas fa-trash"></i>
                      </button>`
                        : ""
                    }
                  </div>
                </td>
              </tr>
            `;
          })
          .join("");
      }

      // Event Listeners
      function setupEventListeners() {
        // Search
        document
          .getElementById("search-input")
          .addEventListener("input", (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = users.filter(
              (user) =>
                user.username.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );
            renderUsers(filteredUsers);
          });

        // User Form
        document
          .getElementById("user-form")
          .addEventListener("submit", saveUser);
      }

      // User Management Functions
      function openCreateUserModal() {
        editingUserId = null;
        document.getElementById("modal-title").textContent = "Neuer Benutzer";
        document.getElementById("password-group").style.display = "block";
        document.getElementById("user-form").reset();
        document.getElementById("user-modal").classList.add("active");
      }

      function editUser(userId) {
        const user = users.find((u) => u.id === userId);
        if (!user) return;

        editingUserId = userId;
        document.getElementById("modal-title").textContent =
          "Benutzer bearbeiten";
        document.getElementById("password-group").style.display = "none";

        document.getElementById("username").value = user.username;
        document.getElementById("email").value = user.email;
        document.getElementById("role").value = user.role;

        document.getElementById("user-modal").classList.add("active");
      }

      async function saveUser(e) {
        e.preventDefault();

        const formData = {
          username: document.getElementById("username").value,
          email: document.getElementById("email").value,
          role: document.getElementById("role").value,
        };

        if (!editingUserId) {
          formData.password = document.getElementById("password").value;
        }

        try {
          document.getElementById("save-btn").disabled = true;
          document.getElementById("save-btn").innerHTML =
            '<div class="spinner"></div>Speichert...';

          const url = editingUserId
            ? `/api/admin/users/${editingUserId}`
            : "/api/admin/users";
          const method = editingUserId ? "PUT" : "POST";

          const response = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
            credentials: "include",
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || "Fehler beim Speichern");
          }

          showAlert(
            editingUserId ? "Benutzer aktualisiert" : "Benutzer erstellt",
            "success"
          );
          closeModal();
          await loadUsers();
          await loadUserStats();
        } catch (error) {
          console.error("Save-Fehler:", error);
          showAlert(error.message, "error");
        } finally {
          document.getElementById("save-btn").disabled = false;
          document.getElementById("save-btn").innerHTML =
            '<i class="fas fa-save"></i> Speichern';
        }
      }

      async function deleteUser(userId) {
        if (!confirm("Benutzer wirklich löschen?")) return;

        try {
          const response = await fetch(`/api/admin/users/${userId}`, {
            method: "DELETE",
            credentials: "include",
          });

          if (!response.ok) throw new Error("Fehler beim Löschen");

          showAlert("Benutzer gelöscht", "success");
          await loadUsers();
          await loadUserStats();
        } catch (error) {
          console.error("Delete-Fehler:", error);
          showAlert("Fehler beim Löschen", "error");
        }
      }

      // License Management
      function manageLicense(userId) {
        const user = users.find((u) => u.id === userId);
        if (!user) return;

        currentUser = user;
        document.getElementById("license-username").textContent = user.username;

        const status = user.license_expires
          ? new Date(user.license_expires) > new Date()
            ? "Gültig"
            : "Abgelaufen"
          : "Keine Lizenz";
        document.getElementById("license-current-status").textContent = status;

        document.getElementById("license-expires").textContent =
          user.license_expires
            ? new Date(user.license_expires).toLocaleDateString("de-DE")
            : "-";

        document.getElementById("license-modal").classList.add("active");
      }

      async function extendLicense() {
        if (!currentUser) return;

        try {
          const response = await fetch(
            `/api/admin/users/${currentUser.id}/extend-license`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
            }
          );

          if (!response.ok)
            throw new Error("Fehler beim Verlängern der Lizenz");

          showAlert("Lizenz um 1 Jahr verlängert", "success");
          closeLicenseModal();
          await loadUsers();
          await loadUserStats();
        } catch (error) {
          console.error("License-Extend Fehler:", error);
          showAlert("Fehler beim Verlängern", "error");
        }
      }

      async function deactivateLicense() {
        if (!currentUser || !confirm("Lizenz wirklich deaktivieren?")) return;

        try {
          const response = await fetch(
            `/api/admin/users/${currentUser.id}/deactivate-license`,
            {
              method: "PUT",
              credentials: "include",
            }
          );

          if (!response.ok)
            throw new Error("Fehler beim Deaktivieren der Lizenz");

          showAlert("Lizenz deaktiviert", "warning");
          closeLicenseModal();
          await loadUsers();
          await loadUserStats();
        } catch (error) {
          console.error("License-Deactivate Fehler:", error);
          showAlert("Fehler beim Deaktivieren", "error");
        }
      }

      // Modal Functions
      function closeModal() {
        document.getElementById("user-modal").classList.remove("active");
      }

      function closeLicenseModal() {
        document.getElementById("license-modal").classList.remove("active");
        currentUser = null;
      }

      // Alert System
      function showAlert(message, type = "info") {
        const alertContainer = document.getElementById("alert-container");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;

        const icon =
          type === "success"
            ? "check-circle"
            : type === "error"
            ? "exclamation-triangle"
            : type === "warning"
            ? "exclamation-circle"
            : "info-circle";

        alert.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;

        alertContainer.innerHTML = "";
        alertContainer.appendChild(alert);

        setTimeout(() => {
          alert.remove();
        }, 5000);
      }

      // Logout Function
      async function logout() {
        try {
          await fetch("/api/auth/logout", {
            method: "POST",
            credentials: "include",
          });
        } catch (error) {
          console.error("Logout-Fehler:", error);
        }

        localStorage.removeItem("user");
        window.location.href = "/login.html";
      }

      // Auto-Refresh
      setInterval(async () => {
        await loadUserStats();
        await loadSystemInfo();
      }, 30000);

      // Keyboard Shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "t") {
          e.preventDefault();
          toggleTheme();
        }
        if (e.key === "Escape") {
          closeModal();
          closeLicenseModal();
        }
      });
    </script>
  </body>
</html>
