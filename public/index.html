<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KFZFacPRO</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/layout-editor.css" />
  </head>
  <body>
    <header class="header">
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <i class="fa-solid fa-wallet"></i>
            KFZ Fac Pro
          </div>
          <nav class="nav">
            <button class="nav-item active" onclick="showSection('dashboard')">
              <i class="fas fa-chart-bar"></i> Dashboard
            </button>
            <button class="nav-item" onclick="showSection('auftraege')">
              <i class="fas fa-clipboard-list"></i> Aufträge
            </button>
            <button class="nav-item" onclick="showSection('rechnungen')">
              <i class="fas fa-file-invoice"></i> Rechnungen
            </button>
            <button class="nav-item" onclick="showSection('kunden')">
              <i class="fas fa-users"></i> Kunden
            </button>
            <button class="nav-item" onclick="showSection('fahrzeuge')">
              <i class="fas fa-car"></i> Fahrzeuge
            </button>
            <button class="nav-item" onclick="showSection('einstellungen')">
              <i class="fas fa-cog"></i> Einstellungen
            </button>
          </nav>

          <!-- User-Bereich mit Logout -->
          <div class="user-section">
            <div class="user-info">
              <span class="user-name" id="user-name">Benutzer</span>
              <span class="license-status" id="license-status"
                >✅ Lizenz aktiv</span
              >
            </div>
            <button class="logout-btn" onclick="logout()" title="Abmelden">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="container">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active fade-in">
          <h1 style="margin-bottom: 2rem; font-size: 2.5rem">Dashboard</h1>

          <div class="dashboard-grid">
            <div class="stat-card">
              <div class="stat-number" id="stat-auftraege">0</div>
              <div class="stat-label">Offene Aufträge</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-rechnungen">0</div>
              <div class="stat-label">Offene Rechnungen</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-kunden">0</div>
              <div class="stat-label">Kunden</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-fahrzeuge">0</div>
              <div class="stat-label">Fahrzeuge</div>
            </div>
          </div>

          <div class="quick-actions">
            <h2>Schnellaktionen</h2>
            <div class="quick-action-grid">
              <button
                class="quick-action-btn"
                onclick="showSection('auftraege'); openAuftragModal()"
              >
                <i class="fas fa-plus"></i>
                Neuer Auftrag
              </button>
              <button
                class="quick-action-btn"
                onclick="showSection('rechnungen'); openRechnungModal()"
              >
                <i class="fas fa-file-invoice"></i>
                Neue Rechnung
              </button>
              <button
                class="quick-action-btn"
                onclick="showSection('kunden'); openKundenModal()"
              >
                <i class="fas fa-user-plus"></i>
                Neuer Kunde
              </button>
              <button
                class="quick-action-btn"
                onclick="showSection('fahrzeuge'); openFahrzeugModal()"
              >
                <i class="fas fa-car"></i>
                Neues Fahrzeug
              </button>
            </div>
          </div>

          <!-- Letzte Aktivitäten -->
          <div class="recent-activities">
            <h2>Letzte Aktivitäten</h2>
            <div class="activity-list" id="activity-list">
              <div class="activity-item">
                <div class="activity-icon">
                  <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="activity-content">
                  <div class="activity-title">Lade Aktivitäten...</div>
                  <div class="activity-time">-</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Aufträge Section -->
        <section id="auftraege" class="section">
          <div class="section-header">
            <h1>Aufträge</h1>
            <button class="btn btn-primary" onclick="openAuftragModal()">
              <i class="fas fa-plus"></i> Neuer Auftrag
            </button>
          </div>

          <div class="filters">
            <input
              type="text"
              class="search-input"
              placeholder="Aufträge suchen..."
              id="auftrag-search"
            />
            <select class="filter-select" id="auftrag-status-filter">
              <option value="">Alle Status</option>
              <option value="offen">Offen</option>
              <option value="in_bearbeitung">In Bearbeitung</option>
              <option value="abgeschlossen">Abgeschlossen</option>
            </select>
          </div>

          <div class="table-container">
            <table class="table" id="auftraege-table">
              <thead>
                <tr>
                  <th>Auftrag-Nr.</th>
                  <th>Kunde</th>
                  <th>Fahrzeug</th>
                  <th>Datum</th>
                  <th>Status</th>
                  <th>Gesamt</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="auftraege-tbody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 2rem">
                    Lade Aufträge...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Rechnungen Section -->
        <section id="rechnungen" class="section">
          <div class="section-header">
            <h1>Rechnungen</h1>
            <button class="btn btn-primary" onclick="openRechnungModal()">
              <i class="fas fa-plus"></i> Neue Rechnung
            </button>
          </div>

          <div class="filters">
            <input
              type="text"
              class="search-input"
              placeholder="Rechnungen suchen..."
              id="rechnung-search"
            />
            <select class="filter-select" id="rechnung-status-filter">
              <option value="">Alle Status</option>
              <option value="offen">Offen</option>
              <option value="bezahlt">Bezahlt</option>
              <option value="mahnung">Mahnung</option>
              <option value="storniert">Storniert</option>
            </select>
          </div>

          <div class="table-container">
            <table class="table" id="rechnungen-table">
              <thead>
                <tr>
                  <th>Rechnung-Nr.</th>
                  <th>Kunde</th>
                  <th>Datum</th>
                  <th>Status</th>
                  <th>Betrag</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="rechnungen-tbody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 2rem">
                    Lade Rechnungen...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Kunden Section -->
        <section id="kunden" class="section">
          <div class="section-header">
            <h1>Kunden</h1>
            <button class="btn btn-primary" onclick="openKundenModal()">
              <i class="fas fa-plus"></i> Neuer Kunde
            </button>
          </div>

          <div class="filters">
            <input
              type="text"
              class="search-input"
              placeholder="Kunden suchen..."
              id="kunden-search"
            />
          </div>

          <div class="table-container">
            <table class="table" id="kunden-table">
              <thead>
                <tr>
                  <th>Kunden-Nr.</th>
                  <th>Name</th>
                  <th>Ort</th>
                  <th>Telefon</th>
                  <th>E-Mail</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="kunden-tbody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 2rem">
                    Lade Kunden...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Fahrzeuge Section -->
        <section id="fahrzeuge" class="section">
          <div class="section-header">
            <h1>Fahrzeuge</h1>
            <button class="btn btn-primary" onclick="openFahrzeugModal()">
              <i class="fas fa-plus"></i> Neues Fahrzeug
            </button>
          </div>

          <div class="filters">
            <input
              type="text"
              class="search-input"
              placeholder="Fahrzeuge suchen..."
              id="fahrzeug-search"
            />
          </div>

          <div class="table-container">
            <table class="table" id="fahrzeuge-table">
              <thead>
                <tr>
                  <th>Kennzeichen</th>
                  <th>Marke/Modell</th>
                  <th>Kunde</th>
                  <th>Baujahr</th>
                  <th>Farbe</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="fahrzeuge-tbody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 2rem">
                    Lade Fahrzeuge...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Einstellungen Section -->
        <section id="einstellungen" class="section">
          <div class="section-header">
            <h1>Einstellungen</h1>
          </div>

          <div class="settings-grid">
            <div class="settings-card">
              <h3>Firma</h3>
              <form id="firma-form">
                <div class="form-group">
                  <label>Firmenname</label>
                  <input type="text" id="firmen_name" class="form-input" />
                </div>
                <div class="form-group">
                  <label>Adresse</label>
                  <textarea id="firma_adresse" class="form-textarea"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Speichern</button>
              </form>
            </div>

            <div class="settings-card">
              <h3>Preise</h3>
              <form id="preise-form">
                <div class="form-group">
                  <label>Basis-Stundenpreis (€)</label>
                  <input
                    type="number"
                    id="basis_stundenpreis"
                    class="form-input"
                    step="0.01"
                  />
                </div>
                <div class="form-group">
                  <label>MwSt.-Satz (%)</label>
                  <input
                    type="number"
                    id="mwst_satz"
                    class="form-input"
                    step="0.01"
                  />
                </div>
                <button type="submit" class="btn btn-primary">Speichern</button>
              </form>
            </div>

            <div class="settings-card">
              <h3>Lizenz-Information</h3>
              <div class="license-info">
                <p>
                  <strong>Status:</strong>
                  <span id="license-info-status">Aktiv</span>
                </p>
                <p>
                  <strong>Läuft ab:</strong>
                  <span id="license-info-expires">-</span>
                </p>
                <p>
                  <strong>Verbleibende Tage:</strong>
                  <span id="license-info-days">-</span>
                </p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Modals werden hier eingefügt -->
    <div id="modal-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Lädt...</p>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Basis-Scripts -->
    <script src="js/app.js"></script>
    <script src="js/api.js"></script>
    <script src="js/modals.js"></script>

    <script>
      // Session-Check und App-Initialisierung
      document.addEventListener("DOMContentLoaded", async () => {
        await checkAuth();
        await initializeApp();
      });

      // Auth-Check mit Lizenz-Validation
      async function checkAuth() {
        try {
          const user = JSON.parse(localStorage.getItem("user") || "{}");

          if (!user.id) {
            window.location.href = "/login.html";
            return;
          }

          // Session-Check beim Server
          const response = await fetch("/api/auth/session-check", {
            credentials: "include",
          });

          if (!response.ok) {
            localStorage.removeItem("user");
            window.location.href = "/login.html";
            return;
          }

          const sessionData = await response.json();

          // User-Daten in Header anzeigen
          document.getElementById("user-name").textContent = user.username;

          // Lizenz-Status laden
          await loadLicenseStatus();
        } catch (error) {
          console.error("Auth-Check Fehler:", error);
          localStorage.removeItem("user");
          window.location.href = "/login.html";
        }
      }

      // Lizenz-Status laden
      async function loadLicenseStatus() {
        try {
          const response = await fetch("/api/auth/license-status", {
            credentials: "include",
          });

          if (response.ok) {
            const licenseData = await response.json();
            const expires = new Date(licenseData.license.expires_at);
            const now = new Date();
            const daysLeft = Math.ceil((expires - now) / (1000 * 60 * 60 * 24));

            const statusElement = document.getElementById("license-status");
            const infoStatus = document.getElementById("license-info-status");
            const infoExpires = document.getElementById("license-info-expires");
            const infoDays = document.getElementById("license-info-days");

            if (daysLeft > 30) {
              statusElement.innerHTML = "✅ Lizenz aktiv";
              statusElement.className = "license-status license-valid";
            } else if (daysLeft > 0) {
              statusElement.innerHTML = `⚠️ Läuft in ${daysLeft} Tagen ab`;
              statusElement.className = "license-status license-warning";
            } else {
              statusElement.innerHTML = "❌ Lizenz abgelaufen";
              statusElement.className = "license-status license-expired";
            }

            if (infoStatus)
              infoStatus.textContent = daysLeft > 0 ? "Aktiv" : "Abgelaufen";
            if (infoExpires)
              infoExpires.textContent = expires.toLocaleDateString("de-DE");
            if (infoDays) infoDays.textContent = Math.max(0, daysLeft);
          }
        } catch (error) {
          console.error("Lizenz-Status Fehler:", error);
        }
      }

      // App initialisieren
      async function initializeApp() {
        await loadDashboardStats();
        // Weitere Initialisierungen...
      }

      // Dashboard-Statistiken laden
      async function loadDashboardStats() {
        try {
          const [auftraege, rechnungen, kunden, fahrzeuge] = await Promise.all([
            fetch("/api/auftraege/stats")
              .then((r) => r.json())
              .catch(() => ({ total: 0, open: 0 })),
            fetch("/api/rechnungen/stats")
              .then((r) => r.json())
              .catch(() => ({ total: 0, open: 0 })),
            fetch("/api/kunden/stats")
              .then((r) => r.json())
              .catch(() => ({ total: 0 })),
            fetch("/api/fahrzeuge/stats")
              .then((r) => r.json())
              .catch(() => ({ total: 0 })),
          ]);

          document.getElementById("stat-auftraege").textContent =
            auftraege.open || 0;
          document.getElementById("stat-rechnungen").textContent =
            rechnungen.open || 0;
          document.getElementById("stat-kunden").textContent =
            kunden.total || 0;
          document.getElementById("stat-fahrzeuge").textContent =
            fahrzeuge.total || 0;
        } catch (error) {
          console.error("Stats-Laden Fehler:", error);
        }
      }

      // Section wechseln
      function showSection(sectionName) {
        // Alle Sections verstecken
        document.querySelectorAll(".section").forEach((section) => {
          section.classList.remove("active");
        });

        // Navigation aktualisierten
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });

        // Gewählte Section zeigen
        document.getElementById(sectionName).classList.add("active");
        event.target.classList.add("active");

        // Section-spezifische Daten laden
        loadSectionData(sectionName);
      }

      // Section-Daten laden
      async function loadSectionData(section) {
        switch (section) {
          case "auftraege":
            await loadAuftraege();
            break;
          case "rechnungen":
            await loadRechnungen();
            break;
          case "kunden":
            await loadKunden();
            break;
          case "fahrzeuge":
            await loadFahrzeuge();
            break;
          case "einstellungen":
            await loadEinstellungen();
            break;
        }
      }

      // Logout-Funktion
      async function logout() {
        try {
          await fetch("/api/auth/logout", {
            method: "POST",
            credentials: "include",
          });
        } catch (error) {
          console.error("Logout-Fehler:", error);
        }

        localStorage.removeItem("user");
        window.location.href = "/login.html";
      }

      // Placeholder-Funktionen für Daten-Loading
      async function loadAuftraege() {
        console.log("Lade Aufträge...");
        // Implementation in separater Datei
      }

      async function loadRechnungen() {
        console.log("Lade Rechnungen...");
        // Implementation in separater Datei
      }

      async function loadKunden() {
        console.log("Lade Kunden...");
        // Implementation in separater Datei
      }

      async function loadFahrzeuge() {
        console.log("Lade Fahrzeuge...");
        // Implementation in separater Datei
      }

      async function loadEinstellungen() {
        console.log("Lade Einstellungen...");
        // Implementation in separater Datei
      }

      // Modal-Funktionen (Placeholder)
      function openAuftragModal() {
        console.log("Öffne Auftrag-Modal");
      }

      function openRechnungModal() {
        console.log("Öffne Rechnung-Modal");
      }

      function openKundenModal() {
        console.log("Öffne Kunden-Modal");
      }

      function openFahrzeugModal() {
        console.log("Öffne Fahrzeug-Modal");
      }
    </script>
  </body>
</html>
