<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KFZ Fac Pro - Meine Firma</title>
    <link rel="icon" type="image/x-icon" href="assets/icon/favicon.ico" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/sidebar.css" />
    <link rel="stylesheet" href="css/layout-editor.css" />
    <link rel="stylesheet" href="css/modal.css" />
    <link rel="stylesheet" href="css/custom-dialogs.css" />
    <style>
      /* Logo Styles */
      .company-logo {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: contain;
        padding: 4px;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img
            src="assets/logo/logo.png"
            alt="Meine Firma Logo"
            class="company-logo"
            onerror="this.style.display='none'"
          />
        </div>
        <div class="sidebar-title">KFZ FacPro</div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Hauptmenü</div>
          <button class="nav-item active" onclick="showSection('dashboard')">
            <i class="fas fa-chart-bar"></i>
            <span class="nav-item-text">Dashboard</span>
          </button>
          <button class="nav-item" onclick="showSection('auftraege')">
            <i class="fas fa-clipboard-list"></i>
            <span class="nav-item-text">Aufträge</span>
          </button>
          <button class="nav-item" onclick="showSection('rechnungen')">
            <i class="fas fa-file-invoice"></i>
            <span class="nav-item-text">Rechnungen</span>
          </button>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Verwaltung</div>
          <button class="nav-item" onclick="showSection('kunden')">
            <i class="fas fa-users"></i>
            <span class="nav-item-text">Kunden</span>
          </button>
          <button class="nav-item" onclick="showSection('fahrzeuge')">
            <i class="fas fa-car"></i>
            <span class="nav-item-text">Fahrzeuge</span>
          </button>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">System</div>
          <button class="nav-item" onclick="showSection('einstellungen')">
            <i class="fas fa-cog"></i>
            <span class="nav-item-text">Einstellungen</span>
          </button>
        </div>
      </nav>

      <div class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-chevron-left"></i>
      </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-content">
      <!-- Top Bar -->
      <div class="top-bar">
        <h1 class="page-title" id="page-title">Dashboard</h1>
        <div class="user-area">
          <div class="user-info" id="user-info">
            <i class="fas fa-user"></i>
            <span id="current-username">Lädt...</span>
          </div>

          <button onclick="handleLogout()" class="logout-btn" title="Abmelden">
            <i class="fas fa-sign-out-alt"></i>
            Abmelden
          </button>
        </div>
      </div>

      <div class="content">
        <main class="main">
          <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active fade-in">
              <h1 style="margin-bottom: 2rem; font-size: 2.5rem">Dashboard</h1>

              <div class="dashboard-grid">
                <div class="stat-card">
                  <div class="stat-number" id="stat-auftraege">0</div>
                  <div class="stat-label">Offene Aufträge</div>
                </div>
                <div
                  class="stat-card"
                  style="
                    background: linear-gradient(
                      135deg,
                      var(--accent-success),
                      #059669
                    );
                  "
                >
                  <div class="stat-number" id="stat-rechnungen">0</div>
                  <div class="stat-label">Offene Rechnungen</div>
                </div>
                <div
                  class="stat-card"
                  style="
                    background: linear-gradient(
                      135deg,
                      var(--accent-warning),
                      #d97706
                    );
                  "
                >
                  <div class="stat-number" id="stat-kunden">0</div>
                  <div class="stat-label">Kunden</div>
                </div>
                <div
                  class="stat-card"
                  style="
                    background: linear-gradient(
                      135deg,
                      var(--accent-danger),
                      #dc2626
                    );
                  "
                >
                  <div class="stat-number" id="stat-umsatz">0€</div>
                  <div class="stat-label">Monatsumsatz</div>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <h2 class="card-title">Aktuelle Aufträge</h2>
                  <button
                    class="btn btn-primary"
                    onclick="showSection('auftraege')"
                  >
                    <i class="fas fa-plus"></i> Neuer Auftrag
                  </button>
                </div>
                <div class="table-container">
                  <table class="table" id="dashboard-auftraege">
                    <thead>
                      <tr>
                        <th>Auftrag-Nr.</th>
                        <th>Kunde</th>
                        <th>Fahrzeug</th>
                        <th>Datum</th>
                        <th>Status</th>
                        <th>Betrag</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- Aufträge Section -->
            <section id="auftraege" class="section">
              <div class="card-header">
                <h1 class="card-title">Aufträge</h1>
                <button class="btn btn-primary" onclick="showAuftragModal()">
                  <i class="fas fa-plus"></i> Neuer Auftrag
                </button>
              </div>

              <div class="card">
                <div class="search-box">
                  <i class="fas fa-search search-icon"></i>
                  <input
                    type="text"
                    class="search-input"
                    id="auftraege-search"
                    placeholder="Aufträge durchsuchen..."
                  />
                </div>
                <div class="table-container">
                  <table class="table" id="auftraege-table">
                    <thead>
                      <tr>
                        <th>Auftrag-Nr.</th>
                        <th>Kunde</th>
                        <th>Fahrzeug</th>
                        <th>Datum</th>
                        <th>Status</th>
                        <th>Gesamtkosten</th>
                        <th>Aktionen</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- Rechnungen Section -->
            <section id="rechnungen" class="section">
              <div class="card-header">
                <h1 class="card-title">Rechnungen</h1>
                <button class="btn btn-primary" onclick="showRechnungModal()">
                  <i class="fas fa-plus"></i> Neue Rechnung
                </button>
              </div>

              <div class="card">
                <div class="search-box">
                  <i class="fas fa-search search-icon"></i>
                  <input
                    type="text"
                    class="search-input"
                    id="rechnungen-search"
                    placeholder="Rechnungen durchsuchen..."
                  />
                </div>
                <div class="table-container">
                  <table class="table" id="rechnungen-table">
                    <thead>
                      <tr>
                        <th>Rechnung-Nr.</th>
                        <th>Kunde</th>
                        <th>Fahrzeug</th>
                        <th>Datum</th>
                        <th>Status</th>
                        <th>Gesamtbetrag</th>
                        <th>Aktionen</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- Kunden Section -->
            <section id="kunden" class="section">
              <div class="card-header">
                <h1 class="card-title">Kunden</h1>
                <button class="btn btn-primary" onclick="showKundenModal()">
                  <i class="fas fa-plus"></i> Neuer Kunde
                </button>
              </div>

              <div class="card">
                <div class="search-box">
                  <i class="fas fa-search search-icon"></i>
                  <input
                    type="text"
                    class="search-input"
                    id="kunden-search"
                    placeholder="Kunden durchsuchen..."
                  />
                </div>
                <div class="table-container">
                  <table class="table" id="kunden-table">
                    <thead>
                      <tr>
                        <th>Kunden-Nr.</th>
                        <th>Name</th>
                        <th>Adresse</th>
                        <th>Telefon</th>
                        <th>E-Mail</th>
                        <th>Aktionen</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- Fahrzeuge Section -->
            <section id="fahrzeuge" class="section">
              <div class="card-header">
                <h1 class="card-title">Fahrzeuge</h1>
                <button class="btn btn-primary" onclick="showFahrzeugModal()">
                  <i class="fas fa-plus"></i> Neues Fahrzeug
                </button>
              </div>

              <div class="card">
                <div class="search-box">
                  <i class="fas fa-search search-icon"></i>
                  <input
                    type="text"
                    class="search-input"
                    id="fahrzeuge-search"
                    placeholder="Fahrzeuge durchsuchen..."
                  />
                </div>
                <div class="table-container">
                  <table class="table" id="fahrzeuge-table">
                    <thead>
                      <tr>
                        <th>Kennzeichen</th>
                        <th>Marke/Modell</th>
                        <th>Besitzer</th>
                        <th>VIN</th>
                        <th>Farbe</th>
                        <th>Aktionen</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- Einstellungen Section -->
            <section id="einstellungen" class="section">
              <h1 style="margin-bottom: 2rem">Einstellungen</h1>

              <!-- Tab-Navigation -->
              <div class="settings-tabs">
                <button
                  class="settings-tab active"
                  data-tab="profil"
                  onclick="showSettingsTab('profil')"
                >
                  <i class="fas fa-user-cog"></i> Profil
                </button>
                <button
                  class="settings-tab"
                  data-tab="firma"
                  onclick="showSettingsTab('firma')"
                >
                  <i class="fas fa-building"></i> Firmendaten
                </button>
                <button
                  class="settings-tab"
                  data-tab="leistungen"
                  onclick="showSettingsTab('leistungen')"
                >
                  <i class="fas fa-tools"></i> Leistungen
                </button>
                <button
                  class="settings-tab"
                  data-tab="rechnungen"
                  onclick="showSettingsTab('rechnungen')"
                >
                  <i class="fas fa-file-invoice"></i> Rechnungen
                </button>
                <button
                  class="settings-tab"
                  data-tab="auftraege"
                  onclick="showSettingsTab('auftraege')"
                >
                  <i class="fas fa-clipboard-list"></i> Aufträge
                </button>
              </div>

              <!-- Firmendaten -->
              <div id="firma-settings" class="settings-content">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Firmendaten</h2>
                  </div>
                  <form id="firma-form">
                    <div class="form-grid">
                      <div class="form-group">
                        <label class="form-label">Firmenname *</label>
                        <input
                          type="text"
                          class="form-input"
                          name="firmenname"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Rechtsform</label>
                        <input
                          type="text"
                          class="form-input"
                          name="rechtsform"
                          placeholder="z.B. GmbH, UG, Einzelunternehmen"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Geschäftsführer</label>
                        <input
                          type="text"
                          class="form-input"
                          name="geschaeftsfuehrer"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Straße, Hausnummer</label>
                        <input
                          type="text"
                          class="form-input"
                          name="firmen_strasse"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">PLZ</label>
                        <input
                          type="text"
                          class="form-input"
                          name="firmen_plz"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Ort</label>
                        <input
                          type="text"
                          class="form-input"
                          name="firmen_ort"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Telefon</label>
                        <input
                          type="tel"
                          class="form-input"
                          name="firmen_telefon"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Fax</label>
                        <input
                          type="tel"
                          class="form-input"
                          name="firmen_fax"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">E-Mail</label>
                        <input
                          type="email"
                          class="form-input"
                          name="firmen_email"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Website</label>
                        <input
                          type="text"
                          class="form-input"
                          name="firmen_website"
                          placeholder="www.ihre-website.de oder https://www.ihre-website.de"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Steuernummer</label>
                        <input
                          type="text"
                          class="form-input"
                          name="steuernummer"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">USt-IdNr.</label>
                        <input
                          type="text"
                          class="form-input"
                          name="umsatzsteuer_id"
                        />
                      </div>
                    </div>

                    <h3 style="margin: 2rem 0 1rem 0">Bankverbindung</h3>
                    <div class="form-grid">
                      <div class="form-group">
                        <label class="form-label">Bank</label>
                        <input
                          type="text"
                          class="form-input"
                          name="bank_name"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">IBAN</label>
                        <input
                          type="text"
                          class="form-input"
                          name="bank_iban"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">BIC</label>
                        <input type="text" class="form-input" name="bank_bic" />
                      </div>
                    </div>

                    <h3 style="margin: 2rem 0 1rem 0">Firmenlogo</h3>
                    <div class="form-group">
                      <label class="form-label">Logo hochladen</label>

                      <button
                        type="button"
                        onclick="uploadLogo()"
                        class="form-input"
                        style="margin-bottom: 1rem"
                      >
                        Logo auswählen
                      </button>

                      <button
                        type="button"
                        class="btn btn-danger btn-sm"
                        onclick="removeLogo()"
                        title="Logo entfernen"
                        id="remove-logo-btn"
                        style="display: none"
                      >
                        <i class="fas fa-trash"></i> Logo entfernen
                      </button>

                      <!-- Hidden Input für Formular -->
                      <input type="hidden" name="firmen_logo" />

                      <div
                        id="logo-preview"
                        style="
                          margin-top: 1rem;
                          border: 2px dashed var(--border-color);
                          border-radius: 8px;
                          padding: 1rem;
                          text-align: center;
                          background: var(--clr-surface-a20);
                          min-height: 120px;
                          display: flex;
                          flex-direction: column;
                          align-items: center;
                          justify-content: center;
                          transition: all 0.3s ease;
                          cursor: pointer;
                        "
                        onclick="uploadLogo()"
                        title="Klicken oder Datei hierher ziehen"
                      >
                        <div
                          class="no-logo"
                          style="color: var(--text-muted); font-style: italic"
                        >
                          Kein Logo hochgeladen - Klicken oder Datei hierher
                          ziehen
                        </div>
                      </div>

                      <small
                        class="text-muted"
                        style="display: block; margin-top: 0.5rem"
                      >
                        Maximale Dateigröße: 2MB. Unterstützte Formate: JPG,
                        PNG, GIF, SVG.
                        <br />Sie können auch Dateien direkt in den
                        Vorschaubereich ziehen.
                      </small>
                    </div>

                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-save"></i> Firmendaten speichern
                    </button>
                  </form>
                </div>
              </div>

              <!-- Leistungen -->
              <div id="leistungen-settings" class="settings-content">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Leistungen & Preise</h2>
                  </div>
                  <form id="leistungen-form">
                    <div class="form-grid">
                      <div class="form-group">
                        <label class="form-label"
                          >Basis-Stundenpreis (€) *</label
                        >
                        <input
                          type="number"
                          step="0.01"
                          class="form-input"
                          name="basis_stundenpreis"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Anfahrtspauschale (€)</label>
                        <input
                          type="number"
                          step="0.01"
                          class="form-input"
                          name="anfahrtspauschale"
                        />
                      </div>
                      <!-- <div class="form-group">
                        <label class="form-label"
                          >Mindestauftragswert (€)</label
                        >
                        <input
                          type="number"
                          step="0.01"
                          class="form-input"
                          name="mindestauftragswert"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label"
                          >Standard Arbeitszeit (Std.)</label
                        >
                        <input
                          type="number"
                          step="0.5"
                          class="form-input"
                          name="standard_arbeitszeit"
                          placeholder="8.0"
                        />
                      </div> -->
                    </div>

                    <h3 style="margin: 2rem 0 1rem 0">Zusatzleistungen</h3>
                    <div class="form-grid">
                      <div class="form-group">
                        <label class="form-label">Express-Zuschlag (%)</label>
                        <input
                          type="number"
                          step="1"
                          class="form-input"
                          name="express_zuschlag"
                          placeholder="20"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Wochenend-Zuschlag (%)</label>
                        <input
                          type="number"
                          step="1"
                          class="form-input"
                          name="wochenend_zuschlag"
                          placeholder="30"
                        />
                      </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-save"></i> Leistungen speichern
                    </button>
                  </form>
                </div>
              </div>

              <!-- Rechnungen -->
              <div id="rechnungen-settings" class="settings-content">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Rechnungseinstellungen</h2>
                  </div>
                  <form id="rechnungen-form">
                    <div class="form-grid">
                      <div class="form-group">
                        <label class="form-label">Mehrwertsteuer (%) *</label>
                        <input
                          type="number"
                          step="1"
                          class="form-input"
                          name="mwst_satz"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label"
                          >Skonto bei Zahlung innerhalb (Tage)</label
                        >
                        <input
                          type="number"
                          class="form-input"
                          name="skonto_tage"
                          placeholder="10"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Skonto-Prozentsatz (%)</label>
                        <input
                          type="number"
                          step="1"
                          class="form-input"
                          name="skonto_prozent"
                          placeholder="2"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Zahlungsziel (Tage)</label>
                        <input
                          type="number"
                          class="form-input"
                          name="zahlungsziel_tage"
                          placeholder="14"
                        />
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Zahlungsbedingungen</label>
                      <textarea
                        class="form-textarea"
                        name="zahlungsbedingungen"
                        rows="4"
                        placeholder="Zahlbar innerhalb 14 Tagen netto."
                      ></textarea>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Gewährleistung</label>
                      <textarea
                        class="form-textarea"
                        name="gewaehrleistung"
                        rows="3"
                        placeholder="3 Jahre auf Lackierarbeiten bei ordnungsgemäßer Behandlung."
                      ></textarea>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Rechnungshinweise</label>
                      <textarea
                        class="form-textarea"
                        name="rechnungshinweise"
                        rows="3"
                        placeholder="Zusätzliche Hinweise die auf jeder Rechnung erscheinen sollen..."
                      ></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-save"></i> Rechnungseinstellungen
                      speichern
                    </button>
                  </form>
                </div>
              </div>

              <!-- Aufträge -->
              <div id="auftraege-settings" class="settings-content">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Auftragseinstellungen</h2>
                  </div>
                  <form id="auftraege-form">
                    <!-- <div class="form-grid">
                      <div class="form-group">
                        <label class="form-label"
                          >Standard Bearbeitungszeit (Tage)</label
                        >
                        <input
                          type="number"
                          class="form-input"
                          name="standard_bearbeitungszeit"
                          placeholder="5"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label"
                          >Automatische Status-Aktualisierung</label
                        >
                        <select class="form-select" name="auto_status_update">
                          <option value="0">Deaktiviert</option>
                          <option value="1">Aktiviert</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label class="form-label"
                          >E-Mail-Benachrichtigung bei neuen Aufträgen</label
                        >
                        <select
                          class="form-select"
                          name="email_benachrichtigung"
                        >
                          <option value="0">Deaktiviert</option>
                          <option value="1">Aktiviert</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label class="form-label"
                          >Benachrichtigungs-E-Mail</label
                        >
                        <input
                          type="email"
                          class="form-input"
                          name="benachrichtigung_email"
                        />
                      </div>
                    </div>-->
                    Weitere Optionen werden noch eingebaut....
                    <h3 style="margin: 2rem 0 1rem 0">
                      Standard Arbeitsschritte
                    </h3>
                    <div class="form-group">
                      <label class="form-label"
                        >Vordefinierte Arbeitsschritte (einer pro Zeile)</label
                      >
                      <textarea
                        class="form-textarea"
                        name="standard_arbeitsschritte"
                        rows="8"
                        placeholder="Demontage/Vorbereitung&#10;Schleifen/Spachteln&#10;Grundierung&#10;Zwischenschliff&#10;Basislack&#10;Klarlack&#10;Polieren/Finish&#10;Montage"
                      ></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-save"></i> Auftragseinstellungen
                      speichern
                    </button>
                  </form>
                </div>
              </div>

              <div id="modal-container"></div>

              <div id="profil-settings" class="settings-content active">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">
                      <i class="fas fa-user-circle"></i> Profil-Informationen
                    </h2>
                  </div>

                  <!-- Benutzer-Info Anzeige -->
                  <div
                    style="
                      display: grid;
                      grid-template-columns: repeat(
                        auto-fit,
                        minmax(250px, 1fr)
                      );
                      gap: 1rem;
                      margin-bottom: 2rem;
                    "
                  >
                    <div
                      style="
                        padding: 1rem;
                        background: var(--clr-surface-a20);
                        border-radius: 8px;
                        border: 1px solid var(--border-color);
                      "
                    >
                      <div
                        style="
                          display: flex;
                          align-items: center;
                          gap: 0.5rem;
                          margin-bottom: 0.5rem;
                        "
                      >
                        <i
                          class="fas fa-user"
                          style="color: var(--accent-primary)"
                        ></i>
                        <strong>Benutzername</strong>
                      </div>
                      <div
                        id="settings-profile-username"
                        style="color: var(--text-primary); font-size: 1.1rem"
                      >
                        Lädt...
                      </div>
                    </div>

                    <div
                      style="
                        padding: 1rem;
                        background: var(--clr-surface-a20);
                        border-radius: 8px;
                        border: 1px solid var(--border-color);
                      "
                    >
                      <div
                        style="
                          display: flex;
                          align-items: center;
                          gap: 0.5rem;
                          margin-bottom: 0.5rem;
                        "
                      >
                        <i
                          class="fas fa-shield-alt"
                          style="color: var(--accent-primary)"
                        ></i>
                        <strong>Rolle</strong>
                      </div>
                      <div
                        id="settings-profile-role"
                        style="color: var(--text-primary); font-size: 1.1rem"
                      >
                        Lädt...
                      </div>
                    </div>

                    <div
                      style="
                        padding: 1rem;
                        background: var(--clr-surface-a20);
                        border-radius: 8px;
                        border: 1px solid var(--border-color);
                      "
                    >
                      <div
                        style="
                          display: flex;
                          align-items: center;
                          gap: 0.5rem;
                          margin-bottom: 0.5rem;
                        "
                      >
                        <i
                          class="fas fa-clock"
                          style="color: var(--accent-primary)"
                        ></i>
                        <strong>Status</strong>
                      </div>
                      <div
                        style="color: var(--accent-primary); font-size: 1.1rem"
                      >
                        Aktiv
                      </div>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">
                      <i class="fas fa-edit"></i> Benutzerdaten ändern
                    </h2>
                  </div>

                  <form id="settings-change-username-form">
                    <div class="form-group">
                      <label class="form-label">Benutzername *</label>
                      <input
                        type="text"
                        class="form-input"
                        id="settings-username-input"
                        name="newUsername"
                        placeholder="Neuer Benutzername"
                        required
                        minlength="3"
                      />
                      <small class="text-muted"
                        >Mindestens 3 Zeichen. Nur Buchstaben, Zahlen und
                        Unterstriche erlaubt.</small
                      >
                    </div>

                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem">
                      <button
                        type="submit"
                        class="btn btn-primary"
                        id="settings-username-submit"
                      >
                        <i class="fas fa-user-edit"></i> Benutzername ändern
                      </button>
                      <button
                        type="button"
                        class="btn btn-secondary"
                        onclick="resetUsernameForm()"
                      >
                        <i class="fas fa-undo"></i> Zurücksetzen
                      </button>
                    </div>
                  </form>
                </div>

                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">
                      <i class="fas fa-lock"></i> Passwort ändern
                    </h2>
                  </div>

                  <form id="settings-change-password-form">
                    <div class="form-grid">
                      <div class="form-group">
                        <label class="form-label">Aktuelles Passwort *</label>
                        <div style="position: relative">
                          <input
                            type="password"
                            class="form-input"
                            id="settings-current-password"
                            name="currentPassword"
                            placeholder="Ihr aktuelles Passwort"
                            required
                          />
                          <button
                            type="button"
                            onclick="toggleSettingsPassword('settings-current-password')"
                            style="
                              position: absolute;
                              right: 10px;
                              top: 50%;
                              transform: translateY(-50%);
                              background: none;
                              border: none;
                              color: var(--text-muted);
                              cursor: pointer;
                            "
                          >
                            <i class="fas fa-eye"></i>
                          </button>
                        </div>
                      </div>

                      <div class="form-group">
                        <label class="form-label">Neues Passwort *</label>
                        <div style="position: relative">
                          <input
                            type="password"
                            class="form-input"
                            id="settings-new-password"
                            name="newPassword"
                            placeholder="Neues Passwort (min. 6 Zeichen)"
                            required
                            oninput="checkSettingsPasswordStrength(this.value)"
                          />
                          <button
                            type="button"
                            onclick="toggleSettingsPassword('settings-new-password')"
                            style="
                              position: absolute;
                              right: 10px;
                              top: 50%;
                              transform: translateY(-50%);
                              background: none;
                              border: none;
                              color: var(--text-muted);
                              cursor: pointer;
                            "
                          >
                            <i class="fas fa-eye"></i>
                          </button>
                        </div>
                        <div
                          id="settings-password-strength"
                          style="display: none; margin-top: 0.5rem"
                        >
                          <div
                            style="
                              height: 4px;
                              background: var(--clr-surface-a20);
                              border-radius: 2px;
                              overflow: hidden;
                              margin-bottom: 0.5rem;
                            "
                          >
                            <div
                              id="settings-strength-fill"
                              style="
                                height: 100%;
                                transition: all 0.3s ease;
                                border-radius: 2px;
                                width: 0;
                              "
                            ></div>
                          </div>
                          <div
                            id="settings-strength-text"
                            style="font-size: 0.8rem; color: var(--text-muted)"
                          ></div>
                        </div>
                      </div>

                      <div class="form-group">
                        <label class="form-label">Passwort bestätigen *</label>
                        <div style="position: relative">
                          <input
                            type="password"
                            class="form-input"
                            id="settings-confirm-password"
                            name="confirmPassword"
                            placeholder="Neues Passwort wiederholen"
                            required
                          />
                          <button
                            type="button"
                            onclick="toggleSettingsPassword('settings-confirm-password')"
                            style="
                              position: absolute;
                              right: 10px;
                              top: 50%;
                              transform: translateY(-50%);
                              background: none;
                              border: none;
                              color: var(--text-muted);
                              cursor: pointer;
                            "
                          >
                            <i class="fas fa-eye"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem">
                      <button
                        type="submit"
                        class="btn btn-primary"
                        id="settings-password-submit"
                      >
                        <i class="fas fa-save"></i> Passwort ändern
                      </button>
                      <button
                        type="button"
                        class="btn btn-secondary"
                        onclick="resetSettingsPasswordForm()"
                      >
                        <i class="fas fa-undo"></i> Zurücksetzen
                      </button>
                    </div>
                  </form>
                </div>

                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">
                      <i class="fas fa-shield-alt"></i> Sicherheit
                    </h2>
                  </div>

                  <div style="display: flex; flex-wrap: wrap; gap: 1rem">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      onclick="showSettingsSessionInfo()"
                    >
                      <i class="fas fa-info-circle"></i> Sitzungsinformationen
                    </button>

                    <button
                      type="button"
                      class="btn"
                      onclick="logoutFromSettings()"
                      style="
                        background: linear-gradient(135deg, #ef4444, #dc2626);
                        color: white;
                      "
                    >
                      <i class="fas fa-sign-out-alt"></i> Alle Sitzungen beenden
                    </button>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </main>
      </div>
    </div>
    <div id="modal-container"></div>

    <script>
      // Globale Variablen
      let userManagementReady = false;

      // Hauptinitialisierung
      document.addEventListener("DOMContentLoaded", function () {
        console.log("🔄 Modal User-Management wird initialisiert...");
        setTimeout(initUserManagement, 800); // Etwas länger warten
      });

      // Zentrale Initialisierung
      async function initUserManagement() {
        try {
          console.log("🔄 Starte User-Management Initialisierung...");

          // 1. User-Info laden
          const user = await loadCurrentUserInfo();
          if (!user) return;

          // 2. UI basierend auf Rolle anpassen
          if (user.role === "admin") {
            console.log("🔑 Admin erkannt - erstelle User-Management...");
            await setupAdminUserManagement();
          } else {
            console.log("🔒 Regular User - verstecke erweiterte Settings...");
            hideAdvancedSettings();
          }

          userManagementReady = true;
          console.log("✅ User-Management erfolgreich initialisiert");
        } catch (error) {
          console.error("❌ User-Management Init Fehler:", error);
        }
      }

      // User-Info laden
      async function loadCurrentUserInfo() {
        try {
          const response = await fetch("/api/auth/status", {
            credentials: "same-origin",
            headers: { "Cache-Control": "no-cache" },
          });

          if (response.ok) {
            const data = await response.json();
            if (data.authenticated && data.user) {
              console.log(
                `✅ User geladen: ${data.user.username} (${data.user.role})`
              );
              return data.user;
            }
          }

          console.warn("⚠️ Nicht authentifiziert");
          return null;
        } catch (error) {
          console.error("❌ Fehler beim Laden der User-Info:", error);
          return null;
        }
      }

      // Erweiterte Settings verstecken für normale User
      function hideAdvancedSettings() {
        const settingsTabs = document.querySelectorAll(
          '.settings-tab[data-tab]:not([data-tab="profil"])'
        );
        const settingsContents = document.querySelectorAll(
          ".settings-content:not(#profil-settings)"
        );

        settingsTabs.forEach((tab) => (tab.style.display = "none"));
        settingsContents.forEach((content) => (content.style.display = "none"));

        console.log("🔒 Erweiterte Einstellungen versteckt");
      }

      // Admin User-Management Setup
      async function setupAdminUserManagement() {
        console.log("🔧 Richte Admin User-Management ein...");

        // 1. User-Management Tab erstellen
        createUserManagementTab();

        // 2. Modal CSS sicherstellen
        ensureModalCSS();

        // 3. Globale Funktionen definieren
        setupGlobalModalFunctions();

        console.log("✅ Admin User-Management bereit");
      }

      // User-Management Tab erstellen
      function createUserManagementTab() {
        const tabsContainer = document.querySelector(".settings-tabs");
        if (!tabsContainer) {
          console.error("❌ Settings-Tabs Container nicht gefunden");
          return;
        }

        // Prüfen ob bereits existiert
        if (document.querySelector('[data-tab="users"]')) {
          console.log("ℹ️ User-Management Tab existiert bereits");
          return;
        }

        console.log("🔧 Erstelle User-Management Tab...");

        // Tab Button erstellen
        const userTab = document.createElement("button");
        userTab.className = "settings-tab";
        userTab.setAttribute("data-tab", "users");
        userTab.innerHTML = '<i class="fas fa-users"></i> Benutzer';

        // Event Listener statt onclick
        userTab.addEventListener("click", () => {
          console.log("🖱️ User-Management Tab geklickt");
          showSettingsTab("users");
        });

        tabsContainer.appendChild(userTab);

        // Content Bereich erstellen
        const settingsContainer =
          document.querySelector("#einstellungen") ||
          document.querySelector(".settings-content").parentNode;

        if (settingsContainer) {
          const userContent = document.createElement("div");
          userContent.id = "users-settings";
          userContent.className = "settings-content";
          userContent.innerHTML = getUserManagementHTML();
          settingsContainer.appendChild(userContent);

          console.log("✅ User-Management Tab und Content erstellt");
        } else {
          console.error("❌ Settings Container nicht gefunden");
        }
      }

      // User-Management HTML
      function getUserManagementHTML() {
        return `
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Benutzerverwaltung</h2>
                <button class="btn btn-primary" id="create-user-btn" type="button">
                    <i class="fas fa-plus"></i> Neuer Benutzer
                </button>
            </div>
            <div class="card-body">
                <div id="users-list-container">
                    <div class="loading" style="text-align: center; padding: 2rem; color: #10b981;">
                        <i class="fas fa-spinner fa-spin"></i> Lade Benutzer...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create User Modal -->
        <div id="create-user-modal-fixed" class="modal-fixed" style="display: none;">
            <div class="modal-overlay-fixed"></div>
            <div class="modal-content-fixed">
                <div class="modal-header-fixed">
                    <h3>Neuen Benutzer erstellen</h3>
                    <button class="modal-close-fixed" id="close-modal-btn" type="button">&times;</button>
                </div>
                <form id="create-user-form-fixed">
                    <div style="padding: 25px;">
                        <div class="form-group">
                            <label class="form-label">Benutzername *</label>
                            <input type="text" name="username" class="form-input" required minlength="3" autocomplete="off">
                            <small class="text-muted">Mindestens 3 Zeichen</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Passwort *</label>
                            <input type="password" name="password" class="form-input" required minlength="6" autocomplete="new-password">
                            <small class="text-muted">Mindestens 6 Zeichen</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rolle</label>
                            <select name="role" class="form-input">
                                <option value="user">Benutzer</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="modal-actions-fixed">
                            <button type="button" class="btn btn-secondary" id="cancel-modal-btn">
                                Abbrechen
                            </button>
                            <button type="submit" class="btn btn-primary" id="submit-user-btn">
                                <i class="fas fa-plus"></i> Benutzer erstellen
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    `;
      }

      // Modal CSS sicherstellen
      function ensureModalCSS() {
        console.log("🎨 Erstelle CSS mit Pointer-Events Fix...");

        const oldCSS = document.getElementById("user-modal-css");
        if (oldCSS) oldCSS.remove();

        const css = `
    .modal-fixed {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 99999 !important;
      display: none !important;
      align-items: center !important;
      justify-content: center !important;
      background: rgba(0, 0, 0, 0.8) !important;
      backdrop-filter: blur(4px) !important;
    }
    
    .modal-fixed[style*="display: flex"] {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* KRITISCH: Overlay fängt alle Clicks ab */
    .modal-overlay-fixed {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      background: transparent !important;
      z-index: 100000 !important;
    }
    
    /* Content ist ÜBER dem Overlay und fängt Events ab */
    .modal-content-fixed {
      position: relative !important;
      background: var(--clr-surface, #2a2a2a) !important;
      border-radius: 12px !important;
      width: 90% !important;
      max-width: 500px !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
      border: 1px solid var(--border-color, #444) !important;
      z-index: 100001 !important; /* HÖHER als Overlay */
      animation: modalSlideIn 0.3s ease-out !important;
      
      /* WICHTIG: Content fängt alle Clicks ab */
      pointer-events: auto !important;
    }
    
    /* Alle anderen CSS-Regeln bleiben gleich */
    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.9) translateY(-20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    .modal-header-fixed {
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      padding: 20px 25px !important;
      border-bottom: 1px solid var(--border-color, #444) !important;
      background: var(--clr-surface-a10, #333) !important;
      border-radius: 12px 12px 0 0 !important;
    }
    
    .modal-header-fixed h3 {
      margin: 0 !important;
      color: var(--text-primary, #e4e4e7) !important;
      font-size: 1.25rem !important;
    }
    
    .modal-close-fixed {
      background: none !important;
      border: none !important;
      font-size: 24px !important;
      color: var(--text-secondary, #9ca3af) !important;
      cursor: pointer !important;
      padding: 5px !important;
      width: 35px !important;
      height: 35px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      border-radius: 6px !important;
      transition: all 0.3s ease !important;
    }
    
    .modal-close-fixed:hover {
      background: rgba(255, 255, 255, 0.1) !important;
      color: var(--text-primary, #e4e4e7) !important;
    }
    
    .modal-actions-fixed {
      display: flex !important;
      gap: 12px !important;
      justify-content: flex-end !important;
      margin-top: 25px !important;
      padding-top: 20px !important;
      border-top: 1px solid var(--border-color, #444) !important;
    }
    
    body.modal-open {
      overflow: hidden !important;
    }
  `;

        const styleSheet = document.createElement("style");
        styleSheet.id = "user-modal-css";
        styleSheet.textContent = css;
        document.head.appendChild(styleSheet);
      }

      // Globale Modal-Funktionen definieren
      function setupGlobalModalFunctions() {
        console.log("🔧 Richte globale Modal-Funktionen ein...");

        // Modal öffnen
        window.openCreateUserModal = function () {
          const modal = document.getElementById("create-user-modal-fixed");
          if (modal) {
            // Body scrollen verhindern
            document.body.classList.add("modal-open");

            // Modal sichtbar machen
            modal.style.display = "flex";
            modal.style.visibility = "visible";
            modal.style.opacity = "1";

            // Debug-Klasse hinzufügen (optional)
            modal.classList.add("modal-debug-visible");

            console.log("✅ Modal geöffnet (VERBESSERT)");
            console.log(
              "📊 Modal computed style:",
              window.getComputedStyle(modal).display
            );
            console.log(
              "📊 Modal z-index:",
              window.getComputedStyle(modal).zIndex
            );
            console.log(
              "📊 Modal visibility:",
              window.getComputedStyle(modal).visibility
            );

            // Focus auf erstes Input
            setTimeout(() => {
              const firstInput = modal.querySelector('input[name="username"]');
              if (firstInput) {
                firstInput.focus();
                console.log("🎯 Focus auf Username Input gesetzt");
              }
            }, 100);
          } else {
            console.error("❌ Modal nicht gefunden");
          }
        };

        // VERBESSERTE Modal Schließen Funktion
        window.closeCreateUserModal = function () {
          const modal = document.getElementById("create-user-modal-fixed");
          const form = document.getElementById("create-user-form-fixed");

          if (modal) {
            // Modal verstecken
            modal.style.display = "none";
            modal.style.visibility = "hidden";
            modal.style.opacity = "0";

            // Debug-Klasse entfernen
            modal.classList.remove("modal-debug-visible");

            // Body scrollen wieder erlauben
            document.body.classList.remove("modal-open");
          }

          if (form) {
            form.reset();
            console.log("✅ Form zurückgesetzt");
          }
        };

        // Event Listeners setzen - DEFINITIVE VERSION
        setTimeout(() => {
          // Button Event Listeners (bleiben gleich)
          const openBtn = document.getElementById("create-user-btn");
          const closeBtn = document.getElementById("close-modal-btn");
          const cancelBtn = document.getElementById("cancel-modal-btn");
          const form = document.getElementById("create-user-form-fixed");

          if (openBtn) {
            openBtn.addEventListener("click", function (e) {
              e.preventDefault();
              window.openCreateUserModal();
            });
          }

          if (closeBtn) {
            closeBtn.addEventListener("click", function (e) {
              e.preventDefault();
              window.closeCreateUserModal();
            });
          }

          if (cancelBtn) {
            cancelBtn.addEventListener("click", function (e) {
              e.preventDefault();
              window.closeCreateUserModal();
            });
          }

          if (form) {
            form.addEventListener("submit", handleCreateUserSubmit);
          }

          const overlay = document.querySelector(".modal-overlay-fixed");
          if (overlay) {
            overlay.addEventListener("click", function (e) {
              console.log("🖱️ Overlay direkt geklickt - Modal schließen");
              window.closeCreateUserModal();
            });
            console.log("✅ Overlay Click Event Listener gesetzt");
          }

          document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
              const modal = document.getElementById("create-user-modal-fixed");
              if (modal && modal.style.display === "flex") {
                window.closeCreateUserModal();
              }
            }
          });

          loadUsersData();
        }, 500);
      }

      // Create User Form Submit Handler
      async function handleCreateUserSubmit(event) {
        event.preventDefault();
        console.log("🔄 Create User Form Submit");

        const form = event.target;
        const formData = new FormData(form);
        const submitBtn = document.getElementById("submit-user-btn");
        const originalText = submitBtn.innerHTML;

        const userData = {
          username: formData.get("username").trim(),
          password: formData.get("password"),
          role: formData.get("role"),
        };

        console.log("📤 User Data:", { ...userData, password: "[HIDDEN]" });

        // Hilfsfunktion für sichere Dialoge mit Fallback
        async function safeAlert(message, type = "info", title = null) {
          try {
            if (typeof customAlert === "function") {
              console.log("🎨 Verwende Custom Dialog");
              await customAlert(message, type, title);
            } else {
              console.log(
                "⚠️ Custom Dialog nicht verfügbar - verwende Fallback"
              );
              alert(message);
            }
          } catch (error) {
            console.error("❌ Dialog-Fehler:", error);
            alert(message); // Ultimate Fallback
          }
        }

        // Validierung mit sicheren Dialogs
        if (!userData.username || userData.username.length < 3) {
          await safeAlert(
            `Ungültiger Benutzername!\n\nEingabe: "${userData.username}"\nErforderlich: Mindestens 3 Zeichen\n\nErlaubt sind:\n• Buchstaben (A-Z, a-z)\n• Zahlen (0-9)\n• Unterstriche (_)\n\nBitte korrigieren Sie die Eingabe.`,
            "warning",
            "Benutzername zu kurz"
          );
          return;
        }

        if (!userData.password || userData.password.length < 6) {
          await safeAlert(
            `Unsicheres Passwort!\n\nPasswort-Länge: ${
              userData.password ? userData.password.length : 0
            } Zeichen\nErforderlich: Mindestens 6 Zeichen\n\nFür bessere Sicherheit verwenden Sie:\n• Mindestens 8 Zeichen\n• Groß- und Kleinbuchstaben\n• Zahlen und Sonderzeichen`,
            "warning",
            "Passwort zu schwach"
          );
          return;
        }

        // Zusätzliche Validierung für Benutzername-Format
        if (!/^[a-zA-Z0-9_]+$/.test(userData.username)) {
          await safeAlert(
            `Ungültiges Benutzername-Format!\n\nBenutzername: "${userData.username}"\n\nNur folgende Zeichen sind erlaubt:\n• Buchstaben (A-Z, a-z)\n• Zahlen (0-9)\n• Unterstriche (_)\n\nKeine Leerzeichen oder Sonderzeichen!`,
            "error",
            "Format-Fehler"
          );
          return;
        }

        try {
          submitBtn.disabled = true;
          submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Wird erstellt...';

          console.log("🔄 Sende Create User Request...");

          const response = await fetch("/api/auth/create-user", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "same-origin",
            body: JSON.stringify(userData),
          });

          console.log("📊 Create User Response Status:", response.status);

          if (response.ok) {
            const result = await response.json();
            console.log("✅ Benutzer erfolgreich erstellt:", result);

            // SOFORT Button zurücksetzen und Modal schließen
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;

            // Modal schließen BEVOR Dialog angezeigt wird
            if (typeof window.closeCreateUserModal === "function") {
              console.log("🔄 Schließe Modal...");
              window.closeCreateUserModal();
            }

            // Daten neu laden
            if (typeof loadUsersData === "function") {
              console.log("🔄 Lade Benutzer-Daten neu...");
              await loadUsersData();
            }

            // Normale Notification verwenden statt Dialog
            if (typeof showNotification === "function") {
              showNotification(
                `Benutzer "${userData.username}" erfolgreich erstellt!`,
                "success"
              );
            }

            // Erfolgs-Dialog NACH Modal-Schließung (optional)
            setTimeout(async () => {
              try {
                await safeAlert(
                  `✅ Benutzer erfolgreich erstellt!\n\nBenutzer-Details:\n• Benutzername: ${userData.username}\n• Rolle: ${userData.role}\n• Status: Aktiv\n\nDer neue Benutzer kann sich jetzt anmelden.`,
                  "success",
                  "Benutzer erstellt"
                );
              } catch (dialogError) {
                console.warn("⚠️ Erfolgs-Dialog Fehler:", dialogError);
                // Ignorieren, da Benutzer bereits erstellt und Modal geschlossen
              }
            }, 500);
          } else {
            const error = await response.json();
            console.error("❌ Create User Error:", error);

            // Button zurücksetzen bei Fehler
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;

            // Fehler-spezifische Behandlung
            let errorMessage = "Fehler beim Erstellen des Benutzers:\n\n";

            if (
              response.status === 409 ||
              error.error?.includes("bereits") ||
              error.error?.includes("exists")
            ) {
              errorMessage += `Benutzername "${userData.username}" ist bereits vergeben!\n\nWählen Sie einen anderen Benutzernamen.`;
            } else if (response.status === 403 || response.status === 401) {
              errorMessage += `Keine Berechtigung!\n\nSie haben nicht die erforderlichen Rechte um Benutzer zu erstellen.`;
            } else {
              errorMessage += `${
                error.error || "Unbekannter Server-Fehler"
              }\n\nHTTP Status: ${response.status}`;
            }

            await safeAlert(
              errorMessage,
              "error",
              "Benutzer-Erstellung fehlgeschlagen"
            );
          }
        } catch (error) {
          console.error(
            "❌ Network Error beim Erstellen des Benutzers:",
            error
          );

          // Button zurücksetzen bei Netzwerk-Fehler
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;

          await safeAlert(
            `Netzwerk-Fehler beim Erstellen des Benutzers:\n\n${
              error.message || "Verbindung fehlgeschlagen"
            }\n\nPrüfen Sie Ihre Internetverbindung und versuchen Sie es erneut.`,
            "error",
            "Verbindungs-Fehler"
          );
        }

        // Sicherheits-Fallback: Button immer zurücksetzen
        setTimeout(() => {
          if (submitBtn.disabled) {
            console.log("🛡️ Sicherheits-Fallback: Button zurücksetzen");
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        }, 10000); // Nach 10 Sekunden
      }

      // Users Daten laden
      async function loadUsersData() {
        const container = document.getElementById("users-list-container");
        if (!container) {
          console.error("❌ Users List Container nicht gefunden");
          return;
        }

        try {
          console.log("🔄 Lade Benutzer...");

          const response = await fetch("/api/auth/users", {
            credentials: "same-origin",
            headers: { "Cache-Control": "no-cache" },
          });

          console.log("📊 Users API Response Status:", response.status);

          if (!response.ok) {
            throw new Error(
              `API Error: ${response.status} ${response.statusText}`
            );
          }

          const users = await response.json();
          console.log("📊 Users API Response:", users);

          displayUsersTable(users, container);
          console.log(`✅ ${users.length} Benutzer geladen`);
        } catch (error) {
          console.error("❌ Fehler beim Laden der Benutzer:", error);
          container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #ef4444;">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Fehler beim Laden der Benutzer</p>
                <small>${error.message}</small>
                <br><br>
                <button class="btn btn-secondary" onclick="loadUsersData()">
                    <i class="fas fa-redo"></i> Erneut versuchen
                </button>
            </div>
        `;
        }
      }

      // Users Tabelle anzeigen
      function displayUsersTable(users, container) {
        const tableHTML = `
    <table class="table">
        <thead>
            <tr>
                <th>Benutzername</th>
                <th>Rolle</th>
                <th>Erstellt</th>
                <th>Letzter Login</th>
                <th>Status</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            ${users
              .map(
                (user) => `
                <tr>
                    <td>
                        ${escapeHtml(user.username)}
                        ${
                          user.role === "admin"
                            ? '<i class="fas fa-crown" style="color: #f59e0b; margin-left: 8px;" title="Administrator"></i>'
                            : ""
                        }
                    </td>
                    <td>
                        <span class="badge ${
                          user.role === "admin" ? "badge-warning" : "badge-info"
                        }">
                            ${user.role === "admin" ? "Admin" : "User"}
                        </span>
                    </td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>${
                      user.last_login_at
                        ? formatDate(user.last_login_at)
                        : "Nie"
                    }</td>
                    <td>
                        <span class="badge ${
                          user.is_active ? "badge-success" : "badge-danger"
                        }">
                            ${user.is_active ? "Aktiv" : "Deaktiviert"}
                        </span>
                    </td>
                    <td>
                        ${generateUserActions(user)}
                    </td>
                </tr>
            `
              )
              .join("")}
        </tbody>
    </table>
  `;

        container.innerHTML = tableHTML;
      }

      function generateUserActions(user) {
        if (user.role === "admin") {
          return `
      <span class="text-muted" title="Administrator-Accounts sind geschützt">
        <i class="fas fa-shield-alt"></i> Geschützt
      </span>
    `;
        }

        return `
    <div class="btn-group">
      <button 
        class="btn btn-sm ${user.is_active ? "btn-warning" : "btn-success"}" 
        onclick="toggleUserStatus(${user.id}, ${user.is_active})"
        title="${
          user.is_active ? "Benutzer deaktivieren" : "Benutzer aktivieren"
        }"
      >
        <i class="fas ${
          user.is_active ? "fa-user-slash" : "fa-user-check"
        }"></i>
        ${user.is_active ? "Deaktivieren" : "Aktivieren"}
      </button>
      <button 
        class="btn btn-sm btn-danger" 
        onclick="deleteUser(${user.id}, '${escapeHtml(user.username)}')"
        title="Benutzer löschen"
      >
        <i class="fas fa-trash"></i>
        Löschen
      </button>
    </div>
  `;
      }

      // User Status ändern
      window.toggleUserStatus = async function (userId, currentStatus) {
        console.log(
          `🔄 Toggle User Status: ID=${userId}, Current=${currentStatus}`
        );

        const action = currentStatus ? "deaktivieren" : "aktivieren";
        const confirmed = await customConfirm(
          `Möchten Sie diesen Benutzer wirklich ${action}?

Dies wird ${
            currentStatus ? "den Zugang sperren" : "den Zugang wieder freigeben"
          }.`,
          `Benutzer ${action}`
        );

        if (!confirmed) return;

        try {
          console.log(`🔄 Sende ${action} Request für User ${userId}...`);

          const response = await fetch(
            `/api/auth/user/${userId}/${
              currentStatus ? "deactivate" : "activate"
            }`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "same-origin",
            }
          );

          console.log(`📊 Toggle Status Response: ${response.status}`);

          if (response.ok) {
            const result = await response.json();
            console.log(`✅ Status erfolgreich geändert:`, result);

            if (typeof showNotification === "function") {
              showNotification(`Benutzer erfolgreich ${action}t`, "success");
            } else {
              alert(`Benutzer erfolgreich ${action}t`);
            }

            // Tabelle neu laden
            await loadUsersData();
          } else {
            const error = await response.json();
            console.error(`❌ Status Change Error:`, error);

            if (typeof showNotification === "function") {
              showNotification(
                `Fehler beim ${action}: ${error.error || "Unbekannter Fehler"}`,
                "error"
              );
            } else {
              alert(
                `Fehler beim ${action}: ${error.error || "Unbekannter Fehler"}`
              );
            }
          }
        } catch (error) {
          console.error(`❌ Network Error beim ${action}:`, error);

          if (typeof showNotification === "function") {
            showNotification(
              `Netzwerkfehler beim ${action} des Benutzers`,
              "error"
            );
          } else {
            alert(`Netzwerkfehler beim ${action} des Benutzers`);
          }
        }
      };

      window.deleteUser = async function (userId, username) {
        console.log(`🔄 Delete User: ID=${userId}, Username=${username}`);

        // Doppelte Bestätigung für Löschung
        const confirmed1 = await customConfirm(
          `⚠️ WARNUNG: Benutzer "${username}" löschen?

Diese Aktion kann NICHT rückgängig gemacht werden!

Alle Daten dieses Benutzers gehen verloren.`,
          "Benutzer löschen - Schritt 1"
        );

        if (!confirmed1) return;

        const confirmed2 = await customConfirm(
          `🚨 LETZTE WARNUNG!

Sie sind dabei "${username}" PERMANENT zu löschen.

Sind Sie sich absolut sicher?`,
          "Benutzer löschen - Schritt 2"
        );

        if (!confirmed2) return;

        try {
          console.log(`🔄 Sende Delete Request für User ${userId}...`);

          const response = await fetch(`/api/auth/user/${userId}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "same-origin",
          });

          console.log(`📊 Delete User Response: ${response.status}`);

          if (response.ok) {
            const result = await response.json();
            console.log(`✅ Benutzer erfolgreich gelöscht:`, result);

            if (typeof showNotification === "function") {
              showNotification(
                `Benutzer "${username}" erfolgreich gelöscht`,
                "success"
              );
            } else {
              alert(`Benutzer "${username}" erfolgreich gelöscht`);
            }

            // Tabelle neu laden
            await loadUsersData();
          } else {
            const error = await response.json();
            console.error(`❌ Delete User Error:`, error);

            if (typeof showNotification === "function") {
              showNotification(
                `Fehler beim Löschen: ${error.error || "Unbekannter Fehler"}`,
                "error"
              );
            } else {
              alert(
                `Fehler beim Löschen: ${error.error || "Unbekannter Fehler"}`
              );
            }
          }
        } catch (error) {
          console.error(`❌ Network Error beim Löschen:`, error);

          if (typeof showNotification === "function") {
            showNotification(
              "Netzwerkfehler beim Löschen des Benutzers",
              "error"
            );
          } else {
            alert("Netzwerkfehler beim Löschen des Benutzers");
          }
        }
      };

      // Hilfsfunktionen
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateString) {
        if (!dateString) return "Nie";
        return new Date(dateString).toLocaleDateString("de-DE", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Settings Tab Navigation erweitern
      if (typeof window.showSettingsTab === "undefined") {
        window.showSettingsTab = function (tabName) {
          console.log("🔄 showSettingsTab:", tabName);

          // Alle Tabs und Content verstecken
          document.querySelectorAll(".settings-tab").forEach((tab) => {
            tab.classList.remove("active");
          });
          document.querySelectorAll(".settings-content").forEach((content) => {
            content.classList.remove("active");
          });

          // Aktiven Tab und Content anzeigen
          const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
          const activeContent = document.getElementById(`${tabName}-settings`);

          if (activeTab) {
            activeTab.classList.add("active");
            console.log("✅ Tab aktiviert:", tabName);
          }
          if (activeContent) {
            activeContent.classList.add("active");
            console.log("✅ Content aktiviert:", tabName);
          }

          // Spezielle Aktionen
          if (tabName === "users" && userManagementReady) {
            setTimeout(() => {
              console.log("🔄 Lade Users für Tab...");
              loadUsersData();
            }, 100);
          }
        };
      }

      // Debug-Funktionen
      window.debugModalFixed = function () {
        console.log("=== MODAL DEBUG FIXED ===");
        console.log("User Management Ready:", userManagementReady);
        console.log(
          "Modal exists:",
          !!document.getElementById("create-user-modal-fixed")
        );
        console.log(
          "Open function exists:",
          typeof window.openCreateUserModalFixed
        );
        console.log(
          "Button exists:",
          !!document.getElementById("create-user-btn")
        );

        // Test Modal öffnen
        console.log("Testing modal open...");
        if (window.openCreateUserModalFixed) {
          window.openCreateUserModalFixed();
        }
      };

      window.testModalFix = function () {
        console.log("🧪 Teste Modal Fix...");

        // Modal erstellen falls nicht vorhanden
        if (!document.getElementById("create-user-modal-fixed")) {
          const testModal = document.createElement("div");
          testModal.id = "create-user-modal-fixed";
          testModal.className = "modal-fixed";
          testModal.innerHTML = `
                    <div class="modal-overlay-fixed"></div>
                    <div class="modal-content-fixed">
                        <div class="modal-header-fixed">
                            <h3>Test Modal</h3>
                            <button class="modal-close-fixed" onclick="closeCreateUserModalFixed()">&times;</button>
                        </div>
                        <div style="padding: 25px;">
                            <p>Dies ist ein Test Modal!</p>
                            <button onclick="closeCreateUserModalFixed()">Schließen</button>
                        </div>
                    </div>
                `;
          document.body.appendChild(testModal);
          console.log("🧪 Test Modal erstellt");
        }

        // CSS sicherstellen
        ensureModalCSS();

        // Modal öffnen
        setTimeout(() => {
          window.openCreateUserModalFixed();
        }, 100);
      };
      window.debugModalElements = function () {
        console.log("=== MODAL DEBUG ===");

        const modal = document.getElementById("create-user-modal-fixed");
        console.log("Modal Element:", modal);

        if (modal) {
          console.log("Modal classList:", modal.classList.toString());
          console.log("Modal style.display:", modal.style.display);
          console.log(
            "Modal computed display:",
            window.getComputedStyle(modal).display
          );
          console.log(
            "Modal computed z-index:",
            window.getComputedStyle(modal).zIndex
          );
          console.log(
            "Modal computed visibility:",
            window.getComputedStyle(modal).visibility
          );
          console.log("Modal offsetWidth:", modal.offsetWidth);
          console.log("Modal offsetHeight:", modal.offsetHeight);
          console.log("Modal parentElement:", modal.parentElement);
        }

        // Alle Elemente mit hohem z-index finden
        const allElements = document.querySelectorAll("*");
        const highZElements = [];

        allElements.forEach((el) => {
          const zIndex = window.getComputedStyle(el).zIndex;
          if (zIndex !== "auto" && parseInt(zIndex) > 9000) {
            highZElements.push({
              element: el,
              zIndex: zIndex,
              tagName: el.tagName,
              className: el.className,
            });
          }
        });

        console.log("Elemente mit hohem z-index:", highZElements);
      };

      console.log("✅ Modal Fix Script geladen");
      console.log("🧪 Verwende testModalFix() zum Testen");
      console.log("🔍 Verwende debugModalElements() für Debug-Info");

      // Globale Funktionen verfügbar machen
      window.loadUsersData = loadUsersData;

      console.log("✅ Modal-Fix User-Management Script geladen");
    </script>

    <script>
      // User-Informationen laden und anzeigen
      async function loadUserInfo() {
        try {
          const response = await fetch("/api/auth/status", {
            credentials: "same-origin",
            headers: {
              "Cache-Control": "no-cache",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();

          if (data.authenticated && data.user) {
            // User-Info anzeigen
            const usernameElement = document.getElementById("current-username");
            if (usernameElement) {
              usernameElement.textContent = data.user.username;
            }

            if (data.user.role === "admin") {
              const userInfo = document.getElementById("user-info");
              if (userInfo && !userInfo.querySelector(".admin-badge")) {
                const adminBadge = document.createElement("span");
                adminBadge.className = "admin-badge";
                adminBadge.textContent = "Admin";
                adminBadge.style.cssText = `
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
          `;
                userInfo.appendChild(adminBadge);
              }
            }

            console.log("✅ Benutzer-Info geladen:", data.user.username);
          } else {
            console.warn(
              "⚠️ Nicht authentifiziert - Weiterleitung zur Login-Seite"
            );
            window.location.href = "/login";
          }
        } catch (error) {
          console.error(
            "❌ Fehler beim Laden der Benutzer-Informationen:",
            error
          );

          console.warn("⚠️ Schwerer Fehler - Weiterleitung zur Login-Seite");
          window.location.href = "/login";
        }
      }

      // Logout-Funktionalität
      async function handleLogout() {
        // Bestätigung mit Custom Dialog anzeigen
        const confirmed = await customConfirm(
          `Möchten Sie sich wirklich abmelden?

Dies beendet:
• Ihre aktuelle Sitzung
• Alle gespeicherten Daten in diesem Browser
• Automatische Anmeldung

Sie müssen sich anschließend neu anmelden.`,
          "Abmeldung bestätigen"
        );

        if (!confirmed) {
          return;
        }

        try {
          console.log("🔄 Logout wird eingeleitet...");

          // Loading-Indikator
          const logoutBtn = document.querySelector(".logout-btn");
          const originalText = logoutBtn.innerHTML;
          logoutBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Abmelden...';
          logoutBtn.disabled = true;

          try {
            const logoutResponse = await fetch("/api/auth/logout", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "same-origin",
            });

            if (logoutResponse.ok) {
              console.log("✅ Server-seitige Abmeldung erfolgreich");
            } else {
              console.warn(
                "⚠️ Server-seitiger Logout hatte Probleme, fahre trotzdem fort"
              );
            }
          } catch (logoutError) {
            console.warn("⚠️ Logout-API-Call fehlgeschlagen:", logoutError);
          }

          // Lokale Daten löschen
          try {
            if (typeof sessionStorage !== "undefined") {
              sessionStorage.clear();
            }
            if (typeof localStorage !== "undefined") {
              localStorage.clear();
            }

            // Globale Variablen zurücksetzen
            if (window.kunden) window.kunden = [];
            if (window.fahrzeuge) window.fahrzeuge = [];
            if (window.auftraege) window.auftraege = [];
            if (window.rechnungen) window.rechnungen = [];
            if (window.einstellungen) window.einstellungen = {};

            console.log("✅ Lokale Daten gelöscht");
          } catch (cleanupError) {
            console.warn("⚠️ Fehler beim Löschen lokaler Daten:", cleanupError);
          }

          // Erfolgs-Nachricht
          if (typeof showNotification === "function") {
            showNotification("Erfolgreich abgemeldet", "success");
          }

          setTimeout(() => {
            console.log("🔄 Weiterleitung zur Login-Seite...");

            const isElectron =
              typeof window !== "undefined" &&
              window.process &&
              window.process.type === "renderer";

            if (isElectron) {
              console.log(
                "🔧 Electron erkannt - verwende optimierte Navigation"
              );

              // Erst den Cache für die aktuelle Seite leeren
              if (window.webContents && window.webContents.session) {
                window.webContents.session.clearCache();
              }

              // Dann zur Login-Seite navigieren mit Cache-Buster
              const timestamp = Date.now();
              window.location.replace(`/login?t=${timestamp}`);

              // Fallback: Komplette Seite neu laden falls nötig
              setTimeout(() => {
                console.log("🔄 Fallback: Vollständiger Reload");
                window.location.reload(true); // Force reload from server
              }, 2000);
            } else {
              // Im Browser: Standard-Navigation
              console.log("🌐 Browser erkannt - verwende Standard-Navigation");
              window.location.href = "/login";
            }
          }, 1000);
        } catch (error) {
          console.error("❌ Schwerwiegender Logout-Fehler:", error);

          // Fehler-Dialog mit Custom Dialog
          await customAlert(
            `Logout-Fehler aufgetreten:

${error.message}

Sie werden trotzdem abgemeldet.`,
            "error",
            "Logout-Problem"
          );

          if (typeof showNotification === "function") {
            showNotification("Abgemeldet (mit Fehlern)", "warning");
          }

          // Notfall-Lösung: Kompletter Reload
          setTimeout(() => {
            console.log("🆘 Notfall-Reload wird ausgeführt");
            window.location.reload(true);
          }, 500);
        }
      }

      // Session-Überwachung
      function startSessionMonitoring() {
        setInterval(async () => {
          try {
            const response = await fetch("/api/auth/status", {
              credentials: "same-origin",
              headers: {
                "Cache-Control": "no-cache",
              },
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (!data.authenticated) {
              console.warn("⚠️ Session abgelaufen");

              if (typeof showNotification === "function") {
                showNotification(
                  "Session abgelaufen. Bitte melden Sie sich erneut an.",
                  "warning"
                );
              }

              setTimeout(() => {
                window.location.href = "/login";
              }, 2000);
            } else {
              if (data.user && data.user.username) {
                const usernameElement =
                  document.getElementById("current-username");
                if (
                  usernameElement &&
                  usernameElement.textContent === "Laden..."
                ) {
                  usernameElement.textContent = data.user.username;
                  console.log("✅ Benutzer-Info aktualisiert");
                }
              }
            }
          } catch (error) {
            console.warn("⚠️ Session-Check fehlgeschlagen:", error);
          }
        }, 3 * 60 * 1000); // 3 Minuten
      }

      // Beim Laden der Seite initialisieren
      document.addEventListener("DOMContentLoaded", function () {
        console.log("🔄 Initialisiere Haupt-App...");

        // User-Info laden
        loadUserInfo();

        // Session-Überwachung starten
        startSessionMonitoring();

        console.log("✅ Auth-System initialisiert");
      });

      // Keyboard-Shortcut für Logout (Ctrl+L)
      document.addEventListener("keydown", function (event) {
        if (event.ctrlKey && event.altKey && event.key.toLowerCase() === "l") {
          event.preventDefault();
          handleLogout();
        }
      });

      // Globale Variable für aktuellen Benutzer
      let currentProfileUser = null;

      // Profil-Informationen beim Laden aktualisieren
      document.addEventListener("DOMContentLoaded", function () {
        // Warte bis authManager verfügbar ist
        setTimeout(updateProfileSettings, 1000);
      });

      // Benutzer-Daten sicher abrufen
      function getCurrentUserSafe() {
        // Versuche verschiedene Wege den aktuellen Benutzer zu bekommen
        if (window.authManager && window.authManager.getCurrentUser) {
          return window.authManager.getCurrentUser();
        }

        if (window.getCurrentUser) {
          return window.getCurrentUser();
        }

        if (currentProfileUser) {
          return currentProfileUser;
        }

        return null;
      }

      // Profil-Einstellungen aktualisieren
      async function updateProfileSettings() {
        let user = getCurrentUserSafe();

        // Falls kein Benutzer gefunden, von API laden
        if (!user) {
          try {
            const response = await fetch("/api/auth/status");
            const data = await response.json();
            if (data.authenticated && data.user) {
              user = data.user;
              currentProfileUser = user;
            }
          } catch (error) {
            console.error("Fehler beim Laden der Benutzerdaten:", error);
            return;
          }
        }

        if (user) {
          const usernameEl = document.getElementById(
            "settings-profile-username"
          );
          const roleEl = document.getElementById("settings-profile-role");

          if (usernameEl) {
            usernameEl.textContent = user.username;
            // Auch das Username-Input-Feld mit aktuellem Wert füllen
            const usernameInput = document.getElementById(
              "settings-username-input"
            );
            if (usernameInput) {
              usernameInput.placeholder = `Aktuell: ${user.username}`;
            }
          }

          if (roleEl) {
            if (user.role === "admin") {
              roleEl.innerHTML =
                'Administrator <span style="background: var(--accent-warning); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">ADMIN</span>';
            } else {
              roleEl.textContent = "Benutzer";
            }
          }
        }
      }

      // Passwort-Sichtbarkeit in Einstellungen umschalten
      function toggleSettingsPassword(inputId) {
        const input = document.getElementById(inputId);
        const button = input.nextElementSibling;
        const icon = button.querySelector("i");

        if (input.type === "password") {
          input.type = "text";
          icon.className = "fas fa-eye-slash";
        } else {
          input.type = "password";
          icon.className = "fas fa-eye";
        }
      }

      // Passwort-Stärke in Einstellungen prüfen
      function checkSettingsPasswordStrength(password) {
        const strengthDiv = document.getElementById(
          "settings-password-strength"
        );
        const strengthFill = document.getElementById("settings-strength-fill");
        const strengthText = document.getElementById("settings-strength-text");

        if (!password) {
          strengthDiv.style.display = "none";
          return;
        }

        strengthDiv.style.display = "block";

        let score = 0;
        let feedback = [];

        // Länge
        if (password.length >= 8) score++;
        else feedback.push("mindestens 8 Zeichen");

        // Großbuchstaben
        if (/[A-Z]/.test(password)) score++;
        else feedback.push("Großbuchstaben");

        // Kleinbuchstaben
        if (/[a-z]/.test(password)) score++;
        else feedback.push("Kleinbuchstaben");

        // Zahlen
        if (/\d/.test(password)) score++;
        else feedback.push("Zahlen");

        // Sonderzeichen
        if (/[^A-Za-z0-9]/.test(password)) score++;
        else feedback.push("Sonderzeichen");

        // Stärke anzeigen
        if (score <= 1) {
          strengthFill.style.background = "#ef4444";
          strengthFill.style.width = "25%";
          strengthText.textContent =
            "Schwach - Fehlt: " + feedback.slice(0, 3).join(", ");
        } else if (score <= 2) {
          strengthFill.style.background = "#f59e0b";
          strengthFill.style.width = "50%";
          strengthText.textContent =
            "Mittelmäßig - Fehlt: " + feedback.slice(0, 2).join(", ");
        } else if (score <= 3) {
          strengthFill.style.background = "#10b981";
          strengthFill.style.width = "75%";
          strengthText.textContent =
            "Gut - Empfohlen: " + (feedback[0] || "Sonderzeichen");
        } else {
          strengthFill.style.background = "#059669";
          strengthFill.style.width = "100%";
          strengthText.textContent = "Stark - Sicheres Passwort";
        }
      }

      // Benutzername-Formular zurücksetzen
      function resetUsernameForm() {
        document.getElementById("settings-change-username-form").reset();
      }

      // Passwort-Formular in Einstellungen zurücksetzen
      function resetSettingsPasswordForm() {
        document.getElementById("settings-change-password-form").reset();
        document.getElementById("settings-password-strength").style.display =
          "none";
      }

      // Sitzungsinformationen in Einstellungen anzeigen - BEREITS mit Custom Dialogs
      async function showSettingsSessionInfo() {
        let user = getCurrentUserSafe();

        // Falls kein Benutzer gefunden, von API laden
        if (!user) {
          try {
            const response = await fetch("/api/auth/status");
            const data = await response.json();
            if (data.authenticated && data.user) {
              user = data.user;
              currentProfileUser = user;
            }
          } catch (error) {
            console.error("Fehler beim Laden der Benutzerdaten:", error);
            await customAlert(
              `Fehler beim Laden der Benutzerdaten:

${error.message || "Unbekannter Fehler"}

Versuchen Sie es erneut oder melden Sie sich neu an.`,
              "error"
            );
            return;
          }
        }

        if (user) {
          const loginTime = user.login_time
            ? new Date(user.login_time).toLocaleString("de-DE")
            : new Date().toLocaleString("de-DE");

          const info = `Aktuelle Sitzung:

👤 Benutzer: ${user.username}
🔑 Rolle: ${user.role}
⏰ Angemeldet seit: ${loginTime}
🌐 Browser: ${navigator.userAgent.split(" ").pop()}
📍 IP-Adresse: ${window.location.hostname}
🔒 Protokoll: ${window.location.protocol}
💾 Session-ID: ${user.session_id || "Nicht verfügbar"}`;

          await customAlert(info, "info", "Sitzungsinformationen");
        } else {
          await customAlert(
            "Keine Benutzerdaten verfügbar.\n\nSie sind möglicherweise nicht angemeldet.",
            "warning",
            "Session-Fehler"
          );
        }
      }

      // Logout von Einstellungen - BEREITS mit Custom Dialogs
      async function logoutFromSettings() {
        const confirmed = await customConfirm(
          `Möchten Sie sich wirklich von allen Geräten abmelden?

Dies beendet:
• Ihre aktuelle Sitzung
• Alle anderen aktiven Sitzungen
• Gespeicherte Login-Daten

Sie müssen sich anschließend neu anmelden.`,
          "Abmeldung bestätigen"
        );

        if (!confirmed) return;

        try {
          // Loading-Anzeige
          if (typeof showNotification === "function") {
            showNotification("Abmeldung wird durchgeführt...", "info");
          }

          const response = await fetch("/api/auth/logout-all", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            await customAlert(
              "✅ Sie wurden erfolgreich von allen Geräten abgemeldet!",
              "success"
            );

            // Kurz warten, dann zur Login-Seite
            setTimeout(() => {
              window.location.href = "/login";
            }, 1500);
          } else {
            throw new Error(`Logout fehlgeschlagen: ${response.status}`);
          }
        } catch (error) {
          console.error("Logout-Fehler:", error);
          await customAlert(
            `Fehler bei der Abmeldung:

${error.message}

Versuchen Sie es erneut oder schließen Sie den Browser.`,
            "error"
          );
        }
      }

      // Event Listener für Formulare in Einstellungen
      document.addEventListener("DOMContentLoaded", function () {
        // Event Listener für Benutzername-Formular
        const usernameForm = document.getElementById(
          "settings-change-username-form"
        );

        if (usernameForm) {
          usernameForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const newUsername = formData.get("newUsername").trim();

            // Validierung
            if (!newUsername) {
              if (typeof showNotification === "function") {
                showNotification("Benutzername ist erforderlich", "error");
              } else {
                alert("Benutzername ist erforderlich");
              }
              return;
            }

            if (newUsername.length < 3) {
              if (typeof showNotification === "function") {
                showNotification(
                  "Benutzername muss mindestens 3 Zeichen lang sein",
                  "error"
                );
              } else {
                alert("Benutzername muss mindestens 3 Zeichen lang sein");
              }
              return;
            }

            // Nur Buchstaben, Zahlen und Unterstriche erlauben
            if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
              if (typeof showNotification === "function") {
                showNotification(
                  "Benutzername darf nur Buchstaben, Zahlen und Unterstriche enthalten",
                  "error"
                );
              } else {
                alert(
                  "Benutzername darf nur Buchstaben, Zahlen und Unterstriche enthalten"
                );
              }
              return;
            }

            // Prüfen ob Username sich geändert hat
            const currentUser = getCurrentUserSafe();
            if (currentUser && currentUser.username === newUsername) {
              if (typeof showNotification === "function") {
                showNotification(
                  "Neuer Benutzername muss sich vom aktuellen unterscheiden",
                  "error"
                );
              } else {
                alert(
                  "Neuer Benutzername muss sich vom aktuellen unterscheiden"
                );
              }
              return;
            }

            const submitBtn = document.getElementById(
              "settings-username-submit"
            );
            const originalText = submitBtn.innerHTML;

            try {
              submitBtn.disabled = true;
              submitBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Wird geändert...';

              const response = await fetch("/api/auth/change-username", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  newUsername: newUsername,
                }),
              });

              const data = await response.json();

              if (response.ok && data.success) {
                if (typeof showNotification === "function") {
                  showNotification(
                    "Benutzername erfolgreich geändert",
                    "success"
                  );
                } else {
                  alert("Benutzername erfolgreich geändert");
                }

                // Benutzerdaten aktualisieren
                if (currentProfileUser) {
                  currentProfileUser.username = newUsername;
                }

                // UI aktualisieren
                updateProfileSettings();

                // Auch den Username in der Hauptnavigation aktualisieren
                const mainUsernameEl =
                  document.getElementById("current-username");
                if (mainUsernameEl) {
                  mainUsernameEl.textContent = newUsername;
                }

                resetUsernameForm();
              } else {
                if (typeof showNotification === "function") {
                  showNotification(
                    data.error || "Fehler beim Ändern des Benutzernamens",
                    "error"
                  );
                } else {
                  alert(data.error || "Fehler beim Ändern des Benutzernamens");
                }
              }
            } catch (error) {
              console.error("Fehler beim Ändern des Benutzernamens:", error);
              if (typeof showNotification === "function") {
                showNotification(
                  "Netzwerkfehler beim Ändern des Benutzernamens",
                  "error"
                );
              } else {
                alert("Netzwerkfehler beim Ändern des Benutzernamens");
              }
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = originalText;
            }
          });
        }

        // Event Listener für Passwort-Formular
        const passwordForm = document.getElementById(
          "settings-change-password-form"
        );

        if (passwordForm) {
          passwordForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const currentPassword = formData.get("currentPassword");
            const newPassword = formData.get("newPassword");
            const confirmPassword = formData.get("confirmPassword");

            // Validierung
            if (!currentPassword || !newPassword || !confirmPassword) {
              if (typeof showNotification === "function") {
                showNotification("Alle Felder sind erforderlich", "error");
              } else {
                alert("Alle Felder sind erforderlich");
              }
              return;
            }

            if (newPassword.length < 6) {
              if (typeof showNotification === "function") {
                showNotification(
                  "Neues Passwort muss mindestens 6 Zeichen lang sein",
                  "error"
                );
              } else {
                alert("Neues Passwort muss mindestens 6 Zeichen lang sein");
              }
              return;
            }

            if (newPassword !== confirmPassword) {
              if (typeof showNotification === "function") {
                showNotification(
                  "Neue Passwörter stimmen nicht überein",
                  "error"
                );
              } else {
                alert("Neue Passwörter stimmen nicht überein");
              }
              return;
            }

            if (currentPassword === newPassword) {
              if (typeof showNotification === "function") {
                showNotification(
                  "Neues Passwort muss sich vom aktuellen unterscheiden",
                  "error"
                );
              } else {
                alert("Neues Passwort muss sich vom aktuellen unterscheiden");
              }
              return;
            }

            const submitBtn = document.getElementById(
              "settings-password-submit"
            );
            const originalText = submitBtn.innerHTML;

            try {
              submitBtn.disabled = true;
              submitBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Wird geändert...';

              const response = await fetch("/api/auth/change-password", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  currentPassword: currentPassword,
                  newPassword: newPassword,
                }),
              });

              const data = await response.json();

              if (response.ok && data.success) {
                if (typeof showNotification === "function") {
                  showNotification("Passwort erfolgreich geändert", "success");
                } else {
                  alert("Passwort erfolgreich geändert");
                }
                resetSettingsPasswordForm();
              } else {
                if (typeof showNotification === "function") {
                  showNotification(
                    data.error || "Fehler beim Ändern des Passworts",
                    "error"
                  );
                } else {
                  alert(data.error || "Fehler beim Ändern des Passworts");
                }
              }
            } catch (error) {
              console.error("Fehler beim Ändern des Passworts:", error);
              if (typeof showNotification === "function") {
                showNotification(
                  "Netzwerkfehler beim Ändern des Passworts",
                  "error"
                );
              } else {
                alert("Netzwerkfehler beim Ändern des Passworts");
              }
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = originalText;
            }
          });
        }

        // Prüfen ob Custom Dialogs verfügbar sind
        if (typeof customAlert === "undefined") {
          console.error("❌ Custom Dialogs nicht geladen in index.html!");

          // Fallback für kritische Funktionen
          window.customAlert = (msg) => alert(msg);
          window.customConfirm = (msg) => confirm(msg);
          window.customPrompt = (msg, def) => prompt(msg, def);
        } else {
          console.log("✅ Custom Dialogs in index.html verfügbar");
        }
      });

      if (typeof window.showSettingsTab === "undefined") {
        window.showSettingsTab = function (tabName) {
          // Alle Tabs und Content verstecken
          document.querySelectorAll(".settings-tab").forEach((tab) => {
            tab.classList.remove("active");
          });
          document.querySelectorAll(".settings-content").forEach((content) => {
            content.classList.remove("active");
          });

          // Aktiven Tab und Content anzeigen
          const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
          const activeContent = document.getElementById(`${tabName}-settings`);

          if (activeTab) activeTab.classList.add("active");
          if (activeContent) activeContent.classList.add("active");

          // Profil-Daten laden wenn Profil-Tab geöffnet wird
          if (tabName === "profil") {
            setTimeout(updateProfileSettings, 100);
          }
        };
      } else {
        // Erweitere bestehende Funktion
        const originalShowSettingsTab = window.showSettingsTab;
        window.showSettingsTab = function (tabName) {
          originalShowSettingsTab(tabName);

          // Profil-Daten laden wenn Profil-Tab geöffnet wird
          if (tabName === "profil") {
            setTimeout(updateProfileSettings, 100);
          }
        };
      }

      // Globale getSetting-Funktion für alle Module
      window.getSetting = function (key, defaultValue = "") {
        if (!window.einstellungen) {
          console.warn(
            `⚠️ Global getSetting: Einstellungen noch nicht geladen für ${key}`
          );
          return defaultValue;
        }

        if (window.einstellungen[key] === undefined) {
          console.warn(`⚠️ Global getSetting: Key '${key}' nicht gefunden`);
          return defaultValue;
        }

        return window.einstellungen[key];
      };

      // Debug-Funktion
      window.debugSettings = function () {
        console.log("=== SETTINGS DEBUG ===");
        console.log("window.einstellungen:", !!window.einstellungen);
        console.log("Keys:", Object.keys(window.einstellungen || {}));
        console.log("Logo vorhanden:", !!window.einstellungen?.firmen_logo);
        console.log(
          "Logo Länge:",
          window.einstellungen?.firmen_logo?.length || "N/A"
        );
        console.log(
          "Erste 50 Zeichen des Logos:",
          window.einstellungen?.firmen_logo?.substring(0, 50) || "N/A"
        );
        console.log(
          "Logo ist Base64:",
          window.einstellungen?.firmen_logo?.startsWith("data:") || false
        );

        // Testen ob Logo noch da ist nach verschiedenen Aktionen
        setTimeout(() => {
          console.log(
            "Logo nach 1 Sekunde:",
            !!window.einstellungen?.firmen_logo
          );
        }, 1000);
      };
    </script>
    <script type="module" src="js/customDialogs.js"></script>
    <script type="module" src="js/app.js"></script>
    <script type="module" src="js/modals.js"></script>
    <script type="module" src="js/notifications.js"></script>
    <script type="module" src="js/utils.js"></script>
    <script type="module" src="js/dashboard.js"></script>
    <script type="module" src="js/einstellungen.js"></script>
    <script type="module" src="js/license.js"></script>
  </body>
</html>
