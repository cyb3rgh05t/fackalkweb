<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Meine Firma</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/login.css" />
    <link rel="stylesheet" href="css/license.css" />
  </head>
  <body>
    <div class="login-container">
      <div class="login-header">
        <div class="company-info">
          <img
            src="assets/logo/logo.png"
            alt="Meine Firma Logo"
            class="company-logo"
          />
          <h1>Meine Firma</h1>
        </div>
        <p>Rechnungs- und Auftragssystem</p>
      </div>

      <form class="login-form" id="loginForm">
        <div
          id="errorMessage"
          style="display: none"
          class="error-message"
        ></div>
        <div
          id="successMessage"
          style="display: none"
          class="success-message"
        ></div>

        <div class="form-group">
          <label class="form-label" for="username">Benutzername</label>
          <div class="input-icon">
            <i class="fas fa-user"></i>
            <input
              type="text"
              class="form-input"
              id="username"
              name="username"
              required
              autocomplete="username"
              placeholder="Benutzername eingeben"
            />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Passwort</label>
          <div class="input-icon">
            <i class="fas fa-lock"></i>
            <input
              type="password"
              class="form-input"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              placeholder="Passwort eingeben"
            />
          </div>
        </div>

        <button type="submit" class="btn-login" id="loginButton">
          <div class="spinner" id="loginSpinner"></div>
          <span id="loginButtonText">Anmelden</span>
        </button>
      </form>

      <div class="login-footer">Secure Login • © 2025 Meine Firma</div>
    </div>

    <div class="version-info">v2.0 + Auth</div>

    <script>
      // Notification System für Login-Seite
      class NotificationManager {
        constructor() {
          this.container = null;
          this.notifications = new Map();
          this.init();
        }

        init() {
          this.container = document.querySelector(".notification-container");
          if (!this.container) {
            this.container = document.createElement("div");
            this.container.className = "notification-container";
            document.body.appendChild(this.container);
          }
        }

        show(message, type = "info", options = {}) {
          const config = {
            duration: 4000,
            closable: true,
            persistent: false,
            showProgress: true,
            ...options,
          };

          const id =
            "notification-" +
            Date.now() +
            "-" +
            Math.random().toString(36).substr(2, 9);
          const notification = this.createElement(message, type, config, id);

          this.init();
          this.container.appendChild(notification);
          this.notifications.set(id, notification);

          requestAnimationFrame(() => {
            notification.classList.add("show");
          });

          if (config.showProgress && !config.persistent) {
            const progressBar = notification.querySelector(
              ".notification-progress"
            );
            if (progressBar) {
              progressBar.style.width = "100%";
              setTimeout(() => {
                progressBar.style.width = "0%";
                progressBar.style.transition = `width ${config.duration}ms linear`;
              }, 50);
            }
          }

          if (!config.persistent) {
            setTimeout(() => {
              this.hide(id);
            }, config.duration);
          }

          return id;
        }

        createElement(message, type, config, id) {
          const notification = document.createElement("div");
          notification.className = `notification notification-${type}`;
          notification.setAttribute("data-id", id);

          let html = `<div class="notification-content">${message}</div>`;

          if (config.closable) {
            html += `<button class="notification-close" aria-label="Schließen">&times;</button>`;
          }

          if (config.showProgress && !config.persistent) {
            html += `<div class="notification-progress"></div>`;
          }

          notification.innerHTML = html;

          if (config.closable) {
            const closeBtn = notification.querySelector(".notification-close");
            closeBtn.addEventListener("click", () => {
              this.hide(id);
            });
          }

          notification.addEventListener("mouseenter", () => {
            const progressBar = notification.querySelector(
              ".notification-progress"
            );
            if (progressBar) {
              progressBar.style.animationPlayState = "paused";
            }
          });

          notification.addEventListener("mouseleave", () => {
            const progressBar = notification.querySelector(
              ".notification-progress"
            );
            if (progressBar) {
              progressBar.style.animationPlayState = "running";
            }
          });

          return notification;
        }

        hide(id) {
          const notification = this.notifications.get(id);
          if (!notification) return;

          notification.classList.remove("show");
          notification.classList.add("hide");

          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
            this.notifications.delete(id);
          }, 300);
        }

        success(message, options = {}) {
          return this.show(message, "success", options);
        }

        error(message, options = {}) {
          return this.show(message, "error", { duration: 6000, ...options });
        }

        warning(message, options = {}) {
          return this.show(message, "warning", options);
        }

        info(message, options = {}) {
          return this.show(message, "info", options);
        }
      }

      // Globale Notification-Instanz
      const notificationManager = new NotificationManager();

      // Globale showNotification Funktion
      function showNotification(message, type = "info", options = {}) {
        return notificationManager.show(message, type, options);
      }

      class LoginManager {
        constructor() {
          this.form = document.getElementById("loginForm");
          this.errorDiv = document.getElementById("errorMessage");
          this.successDiv = document.getElementById("successMessage");
          this.loginButton = document.getElementById("loginButton");
          this.loginSpinner = document.getElementById("loginSpinner");
          this.loginButtonText = document.getElementById("loginButtonText");

          this.init();
        }

        init() {
          this.form.addEventListener("submit", (e) => this.handleLogin(e));

          document.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !this.loginButton.disabled) {
              this.form.dispatchEvent(new Event("submit"));
            }
          });

          document.getElementById("username").focus();
          this.checkAuthStatus();

          // Logo Fallback
          this.setupLogoFallback();
        }

        setupLogoFallback() {
          const logo = document.querySelector(".company-logo");
          if (logo) {
            logo.addEventListener("error", () => {
              // Fallback zu Font Awesome Icon wenn Logo nicht gefunden wird
              const companyInfo = document.querySelector(".company-info");
              logo.style.display = "none";

              if (!companyInfo.querySelector(".fa-car")) {
                const icon = document.createElement("i");
                icon.className = "fas fa-car";
                icon.style.fontSize = "2rem";
                icon.style.marginRight = "0.75rem";
                icon.style.color = "rgba(255, 255, 255, 0.9)";
                companyInfo.insertBefore(icon, companyInfo.querySelector("h1"));
              }
            });
          }
        }

        async checkAuthStatus() {
          try {
            const response = await fetch("/api/auth/status");
            const data = await response.json();

            if (data.authenticated) {
              showNotification(
                "Sie sind bereits angemeldet. Weiterleitung...",
                "info"
              );
              setTimeout(() => {
                window.location.href = "/";
              }, 1500);
            }
          } catch (error) {
            console.log("Auth-Status-Prüfung fehlgeschlagen:", error);
          }
        }

        async handleLogin(e) {
          e.preventDefault();

          const formData = new FormData(this.form);
          const loginData = {
            username: formData.get("username").trim(),
            password: formData.get("password"),
          };

          if (!loginData.username || !loginData.password) {
            showNotification("Bitte alle Felder ausfüllen", "warning");
            this.showError("Bitte alle Felder ausfüllen");
            return;
          }

          this.setLoading(true);
          this.hideMessages();

          try {
            const response = await fetch("/api/auth/login", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(loginData),
            });

            const data = await response.json();

            if (response.ok && data.success) {
              showNotification(
                "Login erfolgreich! Weiterleitung...",
                "success"
              );
              this.showSuccess("Login erfolgreich! Weiterleitung...");
              setTimeout(() => {
                window.location.href = "/";
              }, 1000);
            } else {
              const errorMessage = data.error || "Login fehlgeschlagen";
              showNotification(errorMessage, "error");
              this.showError(errorMessage);
            }
          } catch (error) {
            console.error("Login-Fehler:", error);
            const errorMessage =
              "Verbindungsfehler. Bitte versuchen Sie es erneut.";
            showNotification(errorMessage, "error");
            this.showError(errorMessage);
          } finally {
            this.setLoading(false);
          }
        }

        setLoading(loading) {
          this.loginButton.disabled = loading;

          if (loading) {
            this.loginSpinner.style.display = "inline-block";
            this.loginButtonText.textContent = "Anmelden...";
          } else {
            this.loginSpinner.style.display = "none";
            this.loginButtonText.textContent = "Anmelden";
          }
        }

        showError(message) {
          this.errorDiv.textContent = message;
          this.errorDiv.style.display = "block";
          this.successDiv.style.display = "none";
        }

        showSuccess(message) {
          this.successDiv.textContent = message;
          this.successDiv.style.display = "block";
          this.errorDiv.style.display = "none";
        }

        hideMessages() {
          this.errorDiv.style.display = "none";
          this.successDiv.style.display = "none";
        }
      }

      // Login-Manager initialisieren wenn DOM geladen ist
      document.addEventListener("DOMContentLoaded", () => {
        new LoginManager();
      });
    </script>
    <script type="module" src="/js/license.js"></script>
  </body>
</html>
