<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Meine Firma</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/login.css" />
    <link rel="stylesheet" href="css/license.css" />
    <style>
      /* Notification Styles f√ºr Login-Seite */
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10001;
        pointer-events: none;
        max-width: calc(100vw - 40px);
      }

      .notification {
        position: relative;
        padding: 12px 16px;
        margin-bottom: 10px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        font-size: 14px;
        line-height: 1.4;
        max-width: 350px;
        min-width: 250px;
        word-wrap: break-word;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
        transform: translateX(100%);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        pointer-events: auto;
        border-left: 4px solid rgba(255, 255, 255, 0.3);
      }

      .notification.show {
        transform: translateX(0);
        opacity: 1;
      }

      .notification.hide {
        transform: translateX(100%);
        opacity: 0;
      }

      .notification-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-left-color: #34d399;
      }

      .notification-error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-left-color: #f87171;
      }

      .notification-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        border-left-color: #fbbf24;
      }

      .notification-info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-left-color: #60a5fa;
      }

      .notification-close {
        position: absolute;
        top: 8px;
        right: 8px;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.8);
        font-size: 16px;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
        transition: color 0.2s ease;
      }

      .notification-close:hover {
        color: white;
      }

      .notification-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 0 0 8px 8px;
        transition: width linear;
      }

      /* Logo Styles */
      .company-logo {
        width: 48px;
        height: 48px;
        margin-right: 0.75rem;
        border-radius: 8px;
        object-fit: contain;
        background: rgba(255, 255, 255, 0.1);
        padding: 4px;
      }

      .login-header {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      .company-info {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
      }

      .company-info h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 300;
      }

      /* Responsive Logo */
      @media (max-width: 480px) {
        .notification-container {
          top: 10px;
          right: 10px;
          left: 10px;
          max-width: none;
        }

        .notification {
          max-width: none;
          min-width: auto;
          font-size: 13px;
        }

        .company-logo {
          width: 40px;
          height: 40px;
          margin-right: 0.5rem;
        }

        .company-info h1 {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <div class="login-header">
        <div class="company-info">
          <img
            src="assets/logo/logo.png"
            alt="Meine Firma Logo"
            class="company-logo"
            onerror="this.style.display='none'"
          />
          <h1>Meine Firma</h1>
        </div>
        <p>Rechnungs- und Auftragssystem</p>
      </div>

      <form class="login-form" id="login-form">
        <!-- Fallback Alert Messages (falls Notifications nicht verf√ºgbar) -->
        <div id="error-alert" style="display: none" class="error-message"></div>
        <div
          id="success-alert"
          style="display: none"
          class="success-message"
        ></div>

        <div class="form-group">
          <label class="form-label" for="username">Benutzername</label>
          <div class="input-icon">
            <i class="fas fa-user"></i>
            <input
              type="text"
              class="form-input"
              id="username"
              name="username"
              required
              autocomplete="username"
              placeholder="Benutzername eingeben"
            />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Passwort</label>
          <div class="input-icon">
            <i class="fas fa-lock"></i>
            <input
              type="password"
              class="form-input"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              placeholder="Passwort eingeben"
            />
          </div>
        </div>

        <button type="submit" class="btn-login" id="login-button">
          <div class="spinner" id="login-spinner" style="display: none"></div>
          <span id="login-button-text">Anmelden</span>
        </button>
      </form>

      <div class="login-footer">Secure Login ‚Ä¢ ¬© 2025 Meine Firma</div>
    </div>

    <div class="version-info">v2.0 + Auth</div>

    <!-- WICHTIG: Dein bestehendes Notification-System einbinden -->
    <script type="module" src="js/notifications.js"></script>

    <script>
      class LoginManager {
        constructor() {
          this.form = null;
          this.isInitialized = false;
          this.notificationSystemReady = false;
          this.init();
        }

        init() {
          // Warten bis DOM vollst√§ndig geladen ist
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () =>
              this.setupForm()
            );
          } else {
            this.setupForm();
          }
        }

        setupForm() {
          try {
            // DOM-Elemente holen
            this.form = document.getElementById("login-form");
            this.usernameInput = document.getElementById("username");
            this.passwordInput = document.getElementById("password");
            this.loginButton = document.getElementById("login-button");
            this.loginSpinner = document.getElementById("login-spinner");
            this.loginButtonText = document.getElementById("login-button-text");
            this.errorDiv = document.getElementById("error-alert");
            this.successDiv = document.getElementById("success-alert");

            // Debug: Element-Status pr√ºfen
            console.log("üîç Element-Status:", {
              form: !!this.form,
              usernameInput: !!this.usernameInput,
              passwordInput: !!this.passwordInput,
              loginButton: !!this.loginButton,
              loginSpinner: !!this.loginSpinner,
              loginButtonText: !!this.loginButtonText,
              errorDiv: !!this.errorDiv,
              successDiv: !!this.successDiv,
            });

            if (!this.form) {
              throw new Error("Login-Form nicht gefunden");
            }

            if (
              !this.usernameInput ||
              !this.passwordInput ||
              !this.loginButton
            ) {
              throw new Error("Kritische Form-Elemente nicht gefunden");
            }

            // Warten auf Notification-System
            this.waitForNotificationSystem();

            // Form zur√ºcksetzen
            this.resetForm();

            // Event-Listener hinzuf√ºgen
            this.setupEventListeners();

            // Als initialisiert markieren
            this.isInitialized = true;
            console.log("‚úÖ LoginManager erfolgreich initialisiert");

            // Focus setzen
            setTimeout(() => {
              if (this.usernameInput) {
                this.usernameInput.focus();
              }
            }, 100);
          } catch (error) {
            console.error(
              "‚ùå Fehler beim Initialisieren des LoginManagers:",
              error
            );
            this.showFallbackError(
              "Initialisierungsfehler. Bitte laden Sie die Seite neu."
            );
          }
        }

        // Warten auf dein Notification-System
        waitForNotificationSystem() {
          const checkNotificationSystem = () => {
            if (typeof window.showNotification === "function") {
              this.notificationSystemReady = true;
              console.log("‚úÖ Notification-System verf√ºgbar");
              return true;
            }
            return false;
          };

          // Sofort pr√ºfen
          if (checkNotificationSystem()) {
            return;
          }

          // Falls nicht sofort verf√ºgbar, alle 100ms pr√ºfen f√ºr max 5 Sekunden
          let attempts = 0;
          const maxAttempts = 50;

          const interval = setInterval(() => {
            attempts++;

            if (checkNotificationSystem()) {
              clearInterval(interval);
            } else if (attempts >= maxAttempts) {
              clearInterval(interval);
              console.warn(
                "‚ö†Ô∏è Notification-System nicht gefunden, verwende Fallback"
              );
            }
          }, 100);
        }

        setupEventListeners() {
          // Event-Listener entfernen falls vorhanden
          this.removeAllEventListeners();

          // Form-Submit Handler
          this.formSubmitHandler = (e) => this.handleFormSubmit(e);
          this.form.addEventListener("submit", this.formSubmitHandler);

          // Input-Handler f√ºr Fehler-Reset
          this.inputHandler = () => this.hideMessages();
          if (this.usernameInput) {
            this.usernameInput.addEventListener("input", this.inputHandler);
          }
          if (this.passwordInput) {
            this.passwordInput.addEventListener("input", this.inputHandler);
          }

          // Keyboard-Handler
          this.keyboardHandler = (e) => this.handleKeyboard(e);
          document.addEventListener("keydown", this.keyboardHandler);

          console.log("‚úÖ Event-Listener erfolgreich eingerichtet");
        }

        removeAllEventListeners() {
          if (this.form && this.formSubmitHandler) {
            this.form.removeEventListener("submit", this.formSubmitHandler);
          }
          if (this.usernameInput && this.inputHandler) {
            this.usernameInput.removeEventListener("input", this.inputHandler);
          }
          if (this.passwordInput && this.inputHandler) {
            this.passwordInput.removeEventListener("input", this.inputHandler);
          }
          if (this.keyboardHandler) {
            document.removeEventListener("keydown", this.keyboardHandler);
          }
        }

        resetForm() {
          if (this.form) {
            this.form.reset();
          }

          if (this.usernameInput) {
            this.usernameInput.disabled = false;
            this.usernameInput.classList.remove("error");
            this.usernameInput.value = "";
          }

          if (this.passwordInput) {
            this.passwordInput.disabled = false;
            this.passwordInput.classList.remove("error");
            this.passwordInput.value = "";
          }

          this.setLoading(false);
          this.hideMessages();

          console.log("‚úÖ Form zur√ºckgesetzt");
        }

        handleKeyboard(event) {
          if (event.key === "Enter" && !event.shiftKey) {
            const activeElement = document.activeElement;
            if (
              activeElement === this.usernameInput ||
              activeElement === this.passwordInput
            ) {
              event.preventDefault();
              this.handleFormSubmit(event);
            }
          }

          if (event.key === "Escape") {
            this.hideMessages();
          }
        }

        async handleFormSubmit(event) {
          event.preventDefault();

          if (!this.isInitialized) {
            console.warn("‚ö†Ô∏è LoginManager noch nicht initialisiert");
            return;
          }

          const username = this.usernameInput.value.trim();
          const password = this.passwordInput.value;

          // Validation
          if (!username) {
            this.showError("Bitte geben Sie einen Benutzernamen ein.");
            if (this.usernameInput) {
              this.usernameInput.classList.add("error");
              this.usernameInput.focus();
            }
            return;
          }

          if (!password) {
            this.showError("Bitte geben Sie ein Passwort ein.");
            if (this.passwordInput) {
              this.passwordInput.classList.add("error");
              this.passwordInput.focus();
            }
            return;
          }

          try {
            this.setLoading(true);
            this.hideMessages();

            console.log("üîÑ Sende Login-Anfrage...");

            const response = await fetch("/api/auth/login", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ username, password }),
            });

            const data = await response.json();

            if (response.ok && data.success) {
              console.log("‚úÖ Login erfolgreich");
              this.showSuccess("Login erfolgreich! Weiterleitung...");

              setTimeout(() => {
                window.location.href = "/";
              }, 1000);
            } else {
              const errorMessage = data.error || "Login fehlgeschlagen";
              console.warn("‚ö†Ô∏è Login fehlgeschlagen:", errorMessage);
              this.showError(errorMessage);

              if (this.usernameInput) {
                this.usernameInput.classList.add("error");
              }
              if (this.passwordInput) {
                this.passwordInput.classList.add("error");
              }

              if (this.usernameInput) {
                this.usernameInput.focus();
                this.usernameInput.select();
              }
            }
          } catch (error) {
            console.error("‚ùå Login-Fehler:", error);
            const errorMessage =
              "Verbindungsfehler. Bitte versuchen Sie es erneut.";
            this.showError(errorMessage);
            this.resetForm();
          } finally {
            this.setLoading(false);
          }
        }

        setLoading(loading) {
          if (this.loginButton) {
            this.loginButton.disabled = loading;
          }

          if (this.usernameInput) {
            this.usernameInput.disabled = loading;
          }

          if (this.passwordInput) {
            this.passwordInput.disabled = loading;
          }

          if (this.loginSpinner && this.loginButtonText) {
            if (loading) {
              this.loginSpinner.style.display = "inline-block";
              this.loginButtonText.textContent = "Anmelden...";
              if (this.loginButton) {
                this.loginButton.style.opacity = "0.8";
              }
            } else {
              this.loginSpinner.style.display = "none";
              this.loginButtonText.textContent = "Anmelden";
              if (this.loginButton) {
                this.loginButton.style.opacity = "1";
              }
            }
          }
        }

        // HAUPTMETHODE: Dein Notification-System verwenden
        showError(message) {
          // 1. Priorit√§t: Dein Notification-System
          if (
            this.notificationSystemReady &&
            typeof window.showNotification === "function"
          ) {
            window.showNotification(message, "error");
          }
          // 2. Fallback: Inline-Message
          else {
            this.showFallbackError(message);
          }

          console.warn("‚ö†Ô∏è Login-Fehler angezeigt:", message);
        }

        showSuccess(message) {
          // 1. Priorit√§t: Dein Notification-System
          if (
            this.notificationSystemReady &&
            typeof window.showNotification === "function"
          ) {
            window.showNotification(message, "success");
          }
          // 2. Fallback: Inline-Message
          else {
            this.showFallbackSuccess(message);
          }

          console.log("‚úÖ Erfolg angezeigt:", message);
        }

        // Fallback-Methoden f√ºr den Fall dass dein System nicht verf√ºgbar ist
        showFallbackError(message) {
          if (this.errorDiv) {
            this.errorDiv.textContent = message;
            this.errorDiv.style.display = "block";
          }
          if (this.successDiv) {
            this.successDiv.style.display = "none";
          }
        }

        showFallbackSuccess(message) {
          if (this.successDiv) {
            this.successDiv.textContent = message;
            this.successDiv.style.display = "block";
          }
          if (this.errorDiv) {
            this.errorDiv.style.display = "none";
          }
        }

        hideMessages() {
          if (this.errorDiv) {
            this.errorDiv.style.display = "none";
          }
          if (this.successDiv) {
            this.successDiv.style.display = "none";
          }

          if (this.usernameInput) {
            this.usernameInput.classList.remove("error");
          }
          if (this.passwordInput) {
            this.passwordInput.classList.remove("error");
          }
        }

        destroy() {
          this.removeAllEventListeners();
          this.isInitialized = false;
          console.log("üßπ LoginManager aufger√§umt");
        }
      }

      // Globale LoginManager-Instanz
      let loginManager = null;

      function initializeLogin() {
        if (loginManager) {
          loginManager.destroy();
        }

        loginManager = new LoginManager();
        console.log("üîÑ Login-Seite initialisiert");
      }

      // Initialisierung
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeLogin);
      } else {
        initializeLogin();
      }

      // Cleanup bei Navigation
      window.addEventListener("beforeunload", () => {
        if (loginManager) {
          loginManager.destroy();
        }
      });

      // Fallback nach 2 Sekunden
      setTimeout(() => {
        if (!loginManager || !loginManager.isInitialized) {
          console.warn("‚ö†Ô∏è Fallback-Initialisierung wird ausgef√ºhrt");
          initializeLogin();
        }
      }, 2000);
    </script>

    <script type="module" src="js/license.js"></script>
  </body>
</html>
